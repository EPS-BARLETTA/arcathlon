<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ArcAthlon-V2</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f6f8fb; --card:#fff; --ink:#0b1220; --muted:#6b7280; --primary:#0a58ff;
    --green:#22c55e; --amber:#f59e0b; --red:#ef4444; --slate:#334155;
    --ring:0 10px 40px rgba(2,6,23,.08); --radius:18px;
    --adviceRing:#c7d2fe; --adviceBg:#eef2ff; --adviceBadge:#4338ca;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; background:var(--bg); color:var(--ink); font:17px/1.35 Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; display:flex; flex-direction:column;}
  .wrap{max-width:980px; margin:0 auto; padding:16px; width:100%}
  h1,h2,h3{margin:0 0 10px; text-align:center}
  h1{font-size:clamp(24px,4vw,36px); font-weight:800}
  h2{font-size:clamp(20px,3vw,28px); font-weight:800}
  h3{font-size:clamp(18px,2.6vw,22px); font-weight:800}
  p{margin:6px 0; color:var(--muted)}
  .card{background:var(--card); border-radius:var(--radius); box-shadow:var(--ring); padding:14px}
  .hidden{display:none!important}
  [hidden]{display:none!important}

  .btns{display:flex; gap:12px; flex-wrap:wrap; justify-content:center; align-items:center}
  button{border:0; border-radius:16px; font-weight:800; cursor:pointer}
  .btn-xl{padding:18px 20px; font-size:20px}
  .btn-lg{padding:16px 18px; font-size:18px}
  .btn-xxl{padding:22px 26px; font-size:28px}
  .b-primary{background:var(--primary); color:#fff}
  .b-green{background:var(--green); color:#fff}
  .b-amber{background:var(--amber); color:#111}
  .b-red{background:var(--red); color:#fff}
  .b-slate{background:var(--slate); color:#fff}
  .b-ghost{background:#eef2f7; color:#0b1220}

  label{display:block; font-weight:800; margin:8px 0 6px}
  input,select{width:100%; padding:14px 16px; border:2px solid #e5e7eb; border-radius:14px; background:#fff; font:inherit}
  input[type=number]{appearance:textfield}

  .grid{display:grid; gap:12px}
  .g2{grid-template-columns:1fr 1fr}
  @media (max-width:720px){ .g2{grid-template-columns:1fr} }

  .hero{display:flex; align-items:center; justify-content:center; min-height:50vh; text-align:center}
  .chrono{display:flex; align-items:center; justify-content:center; gap:12px; flex-wrap:wrap}
  .time{font-size:clamp(44px,9vw,78px); font-weight:900; letter-spacing:1px}
  .pill{display:inline-block; padding:6px 12px; border-radius:999px; background:#eef2f7; font-weight:800}

  .bigNum{font-size:48px; font-weight:900; text-align:center; margin-top:6px} /* nombre de tours centr√© sous le titre */
  .kpi{display:flex; gap:10px; justify-content:center; flex-wrap:wrap}
  .kchip{padding:8px 12px; border-radius:12px; font-weight:800}
  .kchip.allowed{background:#dbeafe; color:#0b1220}
  .kchip.shot{background:#ede9fe; color:#111827}
  .kchip.remain{background:#dcfce7; color:#065f46}
  .glow{animation:pulse 1s infinite alternate}
  @keyframes pulse{from{box-shadow:0 0 0 rgba(34,197,94,0)} to{box-shadow:0 0 18px rgba(34,197,94,.55)}}

  .shot-grid{display:grid; grid-template-columns:repeat(6,1fr); gap:10px}
  .shot-grid button{padding:16px 0; font-size:22px; border-radius:14px; font-weight:900}

  .advice{margin-top:10px; border:2px solid var(--adviceRing); background:var(--adviceBg); border-radius:16px; padding:12px 14px; text-align:center}
  .ad-badge{display:inline-block; padding:4px 10px; border-radius:999px; font-weight:800; color:#fff; background:var(--adviceBadge); font-size:14px}
  .ad-text{margin-top:6px; font-size:18px; color:#0b1220; font-weight:800}

  details{background:#f8fafc; border:1px dashed #dbe1ea; border-radius:12px; padding:8px 10px}
  details > summary{cursor:pointer; font-weight:800; margin:6px 0}
  table{width:100%; border-collapse:collapse}
  th,td{padding:10px; border-bottom:1px solid #e5e7eb; text-align:center}

  .toast{ position:fixed; left:50%; bottom:84px; transform:translateX(-50%); background:#111827; color:#fff; padding:10px 14px; border-radius:10px;
    box-shadow:0 10px 30px rgba(2,6,23,.35); font-weight:800; z-index:70; opacity:0; pointer-events:none; transition:opacity .2s, transform .2s; max-width:92vw; text-align:center}
  .toast.show{opacity:1; transform:translateX(-50%) translateY(-6px)}

  .banner{background:#fff7ed; border:2px dashed #f59e0b; color:#7c2d12; border-radius:12px; padding:8px 10px; text-align:center; font-weight:800}
  .banner.zone2{background:#ecfeff; border-color:#06b6d4; color:#155e75}

  .runnerBadge{
    display:flex; align-items:center; justify-content:center;
    margin:8px auto 0; min-height:56px; padding:10px 18px; max-width:420px;
    background:var(--green); color:#fff; border-radius:16px; font-weight:900; font-size:22px; text-transform:uppercase;
  }

  .endbar{margin-top:10px; text-align:center}
  .endbar .actions{display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:8px}

  /* Modales */
  .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:80;
    background:linear-gradient(180deg,rgba(2,6,23,.55),rgba(2,6,23,.35));}
  .modal.show{display:flex;}
  .modal-card{background:#fff; border-radius:20px; max-width:900px; width:92%; overflow:hidden; box-shadow:0 12px 48px rgba(2,6,23,.25)}
  .modal-head{display:flex; align-items:center; gap:12px; padding:16px 18px; color:#fff; font-weight:800}
  .modal-head.help{background:linear-gradient(90deg,#0a58ff,#7c3aed)}
  .modal-head.safe{background:linear-gradient(90deg,#22c55e,#0ea5e9)}
  .modal-head.indice{background:linear-gradient(90deg,#111827,#0a58ff)}
  .modal-head.settings{background:linear-gradient(90deg,#0a58ff,#22c55e)}
  .modal-body{padding:18px}
  .help-list{margin:8px 0 12px; line-height:1.55}
  .help-list li{margin:6px 0}

  footer{margin-top:auto; padding:10px; text-align:center; color:var(--muted)}
</style>
</head>
<body>
  <div class="wrap">
    <!-- ACCUEIL -->
    <section id="view-cover" class="card hero">
      <div style="width:100%; max-width:640px; margin:0 auto;">
        <h1>ArcAthlon-V2</h1>
        <p class="muted">EPS ‚Ä¢ ScanProf ready</p>

        <div class="btns" style="margin-top:14px">
          <button id="btnStartApp" class="b-primary btn-xxl">‚ñ∂Ô∏è D√©marrer</button>
        </div>
        <div class="btns" style="margin-top:10px">
          <button id="btnHelp" class="b-slate btn-lg">‚ÑπÔ∏è Aide</button>
          <button id="btnSafety" class="b-ghost btn-lg">üõü Fiche s√©curit√©</button>
          <button id="btnIndice" class="b-ghost btn-lg">üéØ Indice arc</button>
          <button id="btnSettings" class="b-ghost btn-lg">‚öôÔ∏è Param√®tres</button>
        </div>
      </div>
    </section>

    <!-- SAISIE -->
    <section id="view-setup" class="card hidden" hidden>
      <h2>Param√®tres & coureurs</h2>
      <div class="grid g2">
        <div>
          <h3>Coureur 1</h3>
          <label>Pr√©nom</label><input id="p1_prenom" autocomplete="off">
          <label>Nom</label><input id="p1_nom" autocomplete="off">
          <label>Classe</label><input id="p1_classe" autocomplete="off">
          <label>Sexe</label>
          <select id="p1_sexe"><option value="">‚Äî</option><option>F</option><option>M</option></select>
        </div>
        <div>
          <h3>Coureur 2</h3>
          <label>Pr√©nom</label><input id="p2_prenom" autocomplete="off">
          <label>Nom</label><input id="p2_nom" autocomplete="off">
          <label>Classe</label><input id="p2_classe" autocomplete="off">
          <label>Sexe</label>
          <select id="p2_sexe"><option value="">‚Äî</option><option>F</option><option>M</option></select>
        </div>
      </div>

      <div class="grid g2" style="margin-top:8px">
        <div>
          <label>Dur√©e (minutes)</label>
          <input id="duree_min" type="number" min="1" step="1" placeholder="ex. 8">
        </div>
        <div>
          <label>Longueur d‚Äôun tour (m)</label>
          <input id="tour_m" type="number" min="10" step="1" placeholder="ex. 200">
        </div>
      </div>

      <div class="grid g2" style="margin-top:8px">
        <div>
          <label>Tours par bloc</label>
          <input id="tours_bloc" type="number" min="1" step="1" value="3">
        </div>
        <div>
          <label>Fl√®ches par bloc</label>
          <input id="fleches_bloc" type="number" min="1" step="1" value="3">
        </div>
      </div>

      <div class="btns" style="margin-top:8px">
        <button class="b-slate btn-lg" id="preset33">3 tours ‚Üí 3 fl√®ches</button>
        <button class="b-slate btn-lg" id="preset11">1 tour ‚Üí 1 fl√®che</button>
        <button class="b-slate btn-lg" id="preset13">1 tour ‚Üí 3 fl√®ches</button>
        <button id="openSettingsFromSetup" class="b-ghost btn-lg">‚öôÔ∏è Param√®tres</button>
      </div>

      <div class="btns" style="margin-top:10px">
        <button id="goCourse" class="b-primary btn-xl" disabled>Acc√©der √† la course</button>
        <button id="goHome" class="b-slate btn-lg">üè† Accueil</button>
      </div>
    </section>

    <!-- COURSE -->
    <section id="view-course" class="hidden" hidden>
      <div class="card">
        <div class="btns" style="justify-content:space-between; gap:8px">
          <button id="backSetup" class="b-slate btn-lg">‚¨Ö Saisie</button>
          <span class="pill" id="metaRunner">‚Äî</span>
        </div>
        <h2 id="runnerTitle">‚Äî</h2>

        <!-- Pr√©nom unique en gros bloc vert -->
        <div id="runnerBadge" class="runnerBadge">‚Äî</div>

        <div class="btns" style="margin:6px 0">
          <span class="pill" id="zoneBadge">Zone 1</span>
        </div>

        <!-- Chrono -->
        <div class="chrono card" style="margin-top:6px">
          <div class="time" id="clock">00:00.0</div>
          <div class="btns">
            <button id="btnStartChrono" class="b-primary btn-xxl">‚ñ∂Ô∏è D√©marrer</button>
            <button id="btnPause" class="b-amber btn-lg" disabled>‚è∏Ô∏è</button>
            <button id="btnReset" class="b-red btn-lg" disabled>‚Ü∫</button>
          </div>
        </div>
        <p class="muted" style="text-align:center">Dur√©e cible : <b id="target"></b> min</p>

        <!-- Bandeau simple Zone 2 (3 fl√®ches) -->
        <div id="zone2Banner" class="banner zone2 hidden" hidden>3 fl√®ches en Zone 2</div>
      </div>

      <div class="grid g2" style="margin-top:10px">
        <!-- Tours -->
        <div class="card">
          <h3>Tours</h3>
          <div class="bigNum" id="laps">0</div>
          <div class="kpi">
            <span class="kchip">1 tour = <b id="lapMeters">‚Äî</b> m</span>
            <span class="kchip">Distance : <b id="liveDistance">0</b> m</span>
          </div>
          <div class="btns" style="margin-top:8px">
            <button id="lapPlus" class="b-green btn-xl">+1 tour</button>
            <button id="lapMinus" class="b-slate btn-lg">‚àí1</button>
          </div>
        </div>

        <!-- Tir -->
        <div class="card">
          <h3>Tir (0,6,7,8,9,10)</h3>
          <div class="kpi" style="margin-bottom:6px">
            <span class="kchip allowed">Autoris√©es : <b id="allowed">0</b></span>
            <span class="kchip shot">Tir√©es : <b id="shotCount">0</b></span>
            <span class="kchip remain" id="remainChip">Restantes : <b id="remain">0</b></span>
            <span class="kchip">Indice : <b id="indiceArc">0</b>%</span>
          </div>

          <div class="advice" id="adviceBox">
            <span class="ad-badge">Conseil</span>
            <div class="ad-text" id="adviceTxt">‚Äî</div>
          </div>

          <div class="shot-grid" id="scoreButtons" style="margin-top:8px">
            <button class="b-slate" data-score="0">0</button>
            <button class="b-slate" data-score="6">6</button>
            <button class="b-slate" data-score="7">7</button>
            <button class="b-slate" data-score="8">8</button>
            <button class="b-slate" data-score="9">9</button>
            <button class="b-slate" data-score="10">10</button>
          </div>

          <details style="margin-top:10px">
            <summary>Voir d√©tails & compteurs</summary>
            <div class="kpi" style="margin-top:6px">
              <span class="kchip">Nb 10 : <b id="c10">0</b></span>
              <span class="kchip">Nb 9 : <b id="c9">0</b></span>
              <span class="kchip">Nb 8 : <b id="c8">0</b></span>
              <span class="kchip">Nb 7 : <b id="c7">0</b></span>
              <span class="kchip">Nb 6 : <b id="c6">0</b></span>
              <span class="kchip">Nb 0 : <b id="c0">0</b></span>
            </div>
            <div style="overflow:auto; margin-top:6px">
              <table>
                <thead><tr><th>#</th><th>Score</th><th>Action</th></tr></thead>
                <tbody id="shotsTable"></tbody>
              </table>
            </div>
          </details>
        </div>
      </div>

      <!-- Bandeau fin de temps (fraction + action) -->
      <div class="card endbar hidden" id="endBar" hidden>
        <h3>‚è±Ô∏è Temps √©coul√© ‚Äî fraction de tour</h3>
        <div class="actions">
          <button class="b-slate btn-lg" data-frac="0">+ 0</button>
          <button class="b-slate btn-lg" data-frac="0.25">+ 1/4</button>
          <button class="b-slate btn-lg" data-frac="0.5">+ 1/2</button>
          <button class="b-slate btn-lg" data-frac="0.75">+ 3/4</button>
          <button class="b-green btn-xl" id="endAction">‚û°Ô∏è Continuer</button>
        </div>
        <p class="muted" id="distanceOut">Distance : ‚Äî m</p>
      </div>
    </section>

    <!-- BILAN / QR -->
    <section id="view-summary" class="card hidden" style="text-align:center" hidden>
      <h2>Bilan ‚Äî QR compatible ScanProf</h2>
      <div id="qr" class="card" style="display:inline-block"></div>

      <div class="card" style="margin-top:8px">
        <div class="btns" style="flex-wrap:wrap">
          <button class="b-primary btn-lg" id="exportCsv">‚¨áÔ∏è Export CSV</button>
        </div>
        <p class="muted" id="profHint" style="margin-top:6px">Le tableau ci-dessous est non-modifiable (Param√®tres simplifi√©s).</p>
      </div>

      <div id="resume" style="margin-top:8px"></div>

      <div class="btns" style="margin-top:10px">
        <button class="b-slate btn-lg" id="backToCourse">‚¨Ö Retour course</button>
        <button class="b-green btn-lg" id="backHome2">üè† Accueil</button>
      </div>
    </section>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <footer>ArcAthlon - √âquipe EPS Lyc√©e Vauban - LUXEMBOURG - JB</footer>

  <!-- Modales info (cach√©es par d√©faut) -->
  <div class="modal" id="modalHelp" hidden>
    <div class="modal-card">
      <div class="modal-head help"><span>‚ÑπÔ∏è</span><span>Mode d‚Äôemploi ‚Äî ArcAthlon-V2</span></div>
      <div class="modal-body">
        <ol class="help-list">
          <li>Saisir pour chaque √©l√®ve : <strong>Pr√©nom</strong>, <strong>Nom</strong>, <strong>Classe</strong>, <strong>Sexe</strong>.</li>
          <li>R√©gler <strong>Dur√©e</strong>, <strong>Longueur tour</strong>, et la r√®gle <strong>Tours ‚Üí Fl√®ches</strong>.</li>
          <li>En course : <strong>Start/Pause</strong> le chrono ; <strong>+1 / ‚àí1</strong> pour les tours.</li>
          <li>Le tir est d√©bloqu√© par <strong>blocs</strong> (selon la r√®gle). Scores : <b>0,6,7,8,9,10</b>.</li>
          <li>Fin du temps : ajuster la <strong>fraction de tour</strong>, puis <strong>Course 2</strong> / <strong>Bilan</strong>.</li>
        </ol>
        <div class="btns"><button class="b-slate btn-lg" data-close>Fermer</button></div>
      </div>
    </div>
  </div>

  <div class="modal" id="modalSafety" hidden>
    <div class="modal-card">
      <div class="modal-head safe"><span>üõü</span><span>Fiche s√©curit√©</span></div>
      <div class="modal-body">
        <h4>Avant l‚Äôactivit√©</h4>
        <ul class="help-list">
          <li>Zone de course d√©gag√©e ; surface adh√©rente ; pas d‚Äôobstacles.</li>
          <li>Pas de tir mat√©rialis√© + zone d‚Äôattente.</li>
          <li>Contr√¥ler arcs/fl√®ches (branches, corde, empennage, pointes).</li>
        </ul>
        <h4>Au pas de tir</h4>
        <ul class="help-list">
          <li>Arc vers les cibles ; on tire <strong>uniquement</strong> sur signal.</li>
          <li>Personne devant la ligne ; on pose l‚Äôarc √† l‚Äôarr√™t.</li>
        </ul>
        <h4>R√©cup√©ration</h4>
        <ul class="help-list">
          <li>Sur signal ; on marche, pas de course devant la cible.</li>
          <li>Retirer la fl√®che dans l‚Äôaxe, main sur la cible.</li>
        </ul>
        <div class="btns"><button class="b-slate btn-lg" data-close>Fermer</button></div>
      </div>
    </div>
  </div>

  <div class="modal" id="modalIndice" hidden>
    <div class="modal-card">
      <div class="modal-head indice"><span>üéØ</span><span>Indice arc ‚Äî explication</span></div>
      <div class="modal-body">
        <p><strong>But :</strong> mesurer la pr√©cision de 0 √† 100%.</p>
        <p><strong>Scores par fl√®che :</strong> 0, 6, 7, 8, 9, 10.</p>
        <p><strong>Calcul :</strong> moyenne des points sur 10, puis sur 100.</p>
        <ul class="help-list">
          <li>Total fl√®ches T = nb0 + nb6 + nb7 + nb8 + nb9 + nb10</li>
          <li>Total points P = 6√ónb6 + 7√ónb7 + 8√ónb8 + 9√ónb9 + 10√ónb10</li>
          <li><b>Indice (%) = (P / T) √∑ 10 √ó 100</b></li>
        </ul>
        <div class="btns"><button class="b-slate btn-lg" data-close>Fermer</button></div>
      </div>
    </div>
  </div>

  <div class="modal" id="modalSettings" hidden>
    <div class="modal-card">
      <div class="modal-head settings"><span>‚öôÔ∏è</span><span>Param√®tres</span></div>
      <div class="modal-body">
        <p>Param√®tres simplifi√©s pour limiter les erreurs en situation :</p>
        <ul class="help-list">
          <li><b>Zones :</b> ‚ÄúZone 1‚Äù affich√©e en badge. Si la vol√©e pr√©c√©dente est faible, <b>‚Äú3 fl√®ches en Zone 2‚Äù</b> s‚Äôaffiche pour la vol√©e suivante.</li>
          <li>Fin du temps : bandeau <b>Fraction</b> + bouton <b>Course 2 / Bilan</b>.</li>
          <li>Pas de changement de coureur pendant une course.</li>
        </ul>
        <p class="muted">Seuils internes (non modifiables) : au moins <b>3 z√©ros</b> dans la vol√©e, ou total de vol√©e ‚â§ <b>20</b>.</p>
        <div class="btns"><button class="b-slate btn-lg" data-close>Fermer</button></div>
      </div>
    </div>
  </div>

  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"
          onerror="window.QRCode=undefined"></script>

<script>
'use strict';

/* ================== Constantes ================== */
const ASSIST_ENABLED = true;     // auto ‚ÄúZone 2‚Äù activ√©e
const ASSIST_THR_ZEROS = 3;      // d√©clenche si >= 3 z√©ros dans la vol√©e
const ASSIST_THR_SUM   = 20;     // ou si somme de la vol√©e <= 20
const qs = sel => document.querySelector(sel);

/* ================== Vues & Modales ================== */
const V = { cover: qs('#view-cover'), setup: qs('#view-setup'), course: qs('#view-course'), summary: qs('#view-summary') };
function show(name){
  Object.values(V).forEach(v=>{ v.classList.add('hidden'); v.setAttribute('hidden',''); });
  const target = V[name];
  if(target){ target.classList.remove('hidden'); target.removeAttribute('hidden'); }
  closeModals(); window.scrollTo(0,0);
}
function openModal(id){ const m=document.getElementById(id); if(!m) return; m.classList.add('show'); m.removeAttribute('hidden'); }
function closeModals(){ document.querySelectorAll('.modal').forEach(m=>{ m.classList.remove('show'); m.setAttribute('hidden',''); }); }
function showToast(msg, ms=1600){ const t=qs('#toast'); t.textContent=msg; t.classList.add('show'); clearTimeout(showToast.t); showToast.t=setTimeout(()=>t.classList.remove('show'),ms); }
document.addEventListener('click',(e)=>{ if(e.target.matches('[data-close]')) closeModals(); });
document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') closeModals(); });

/* Boutons info */
qs('#btnHelp').onclick   = ()=> openModal('modalHelp');
qs('#btnSafety').onclick = ()=> openModal('modalSafety');
qs('#btnIndice').onclick = ()=> openModal('modalIndice');
qs('#btnSettings').onclick = ()=> openModal('modalSettings');
qs('#openSettingsFromSetup').onclick = ()=> openModal('modalSettings');

/* Navigation */
qs('#btnStartApp').onclick = ()=> show('setup');
qs('#goHome').onclick      = ()=> show('cover');
qs('#backSetup').onclick   = ()=> show('setup');
qs('#backHome2').onclick   = ()=> show('cover');

/* ================== Validation saisie ================== */
function clean(s){ return (s||'').replace(/\s+/g,' ').trim(); }
function val(id){ return clean(document.getElementById(id).value); }
function okNum(v,min){ const n=+v; return Number.isFinite(n) && n>=min; }
function mark(el, good){ el.style.borderColor = good ? '#e5e7eb' : '#ef4444'; }
function validate(){
  const req = ['p1_prenom','p1_nom','p1_classe','p1_sexe','p2_prenom','p2_nom','p2_classe','p2_sexe'];
  let ok = true;
  req.forEach(id=>{ const el=document.getElementById(id); const good=val(id).length>0; mark(el,good); ok=ok&&good; });
  ['duree_min','tour_m','tours_bloc','fleches_bloc'].forEach(id=>{
    const good = okNum(val(id), id==='tour_m'?10:1);
    mark(document.getElementById(id), good); ok = ok && good;
  });
  qs('#goCourse').disabled = !ok; return ok;
}
['p1_prenom','p1_nom','p1_classe','p1_sexe','p2_prenom','p2_nom','p2_classe','p2_sexe','duree_min','tour_m','tours_bloc','fleches_bloc']
.forEach(id=>{ const el=document.getElementById(id); el.addEventListener('input',validate); el.addEventListener('change',validate); });

/* Presets tours‚Üífl√®ches */
qs('#preset33').onclick = ()=>{ document.getElementById('tours_bloc').value=3; document.getElementById('fleches_bloc').value=3; validate(); };
qs('#preset11').onclick = ()=>{ document.getElementById('tours_bloc').value=1; document.getElementById('fleches_bloc').value=1; validate(); };
qs('#preset13').onclick = ()=>{ document.getElementById('tours_bloc').value=1; document.getElementById('fleches_bloc').value=3; validate(); };

/* ================== Session & √©tats course ================== */
const session={
  p1:null, p2:null, tourM:0, dureeMin:0, rules:{tb:3,fb:3},
  active:'p1', laps:0, frac:0, shots:[], results:{p1:null,p2:null}
};
let raceRunning=false, timeOver=false, running=false, timer=null, t0=0, elapsed=0;
let phase='runner1';                  // 'runner1' -> 'runner2' -> 'done'
let zone2ShotsRemaining=0;            // 3 fl√®ches √† consommer si Z2 d√©clench√©e

/* ================== Entr√©e en course ================== */
qs('#goCourse').onclick=()=>{
  if(!validate()){ showToast('Compl√©tez tous les champs (dont Sexe).'); return; }
  function sex(id){ const s=(val(id)||'').toUpperCase(); return s==='M'?'M':'F'; }
  session.p1={ prenom:val('p1_prenom'), nom:val('p1_nom'), classe:val('p1_classe'), sexe:sex('p1_sexe') };
  session.p2={ prenom:val('p2_prenom'), nom:val('p2_nom'), classe:val('p2_classe'), sexe:sex('p2_sexe') };
  session.dureeMin=+val('duree_min'); session.tourM=+val('tour_m');
  session.rules.tb=+document.getElementById('tours_bloc').value;
  session.rules.fb=+document.getElementById('fleches_bloc').value;

  phase='runner1'; session.active='p1';
  resetAdviceHistory(); zone2ShotsRemaining=0;
  timeOver=false; raceRunning=false; running=false; elapsed=0;

  resetRunnerState(true);
  paintHeader(); paintRunnerBadge(); setAdvice("Respire calmement. Reste concentr√©.");
  show('course');
};

/* ================== Chrono ================== */
const clockEl=qs('#clock'), targetEl=qs('#target');
qs('#btnStartChrono').onclick=start; qs('#btnPause').onclick=pause; qs('#btnReset').onclick=reset;
function start(){
  if(running) return;
  running=true; raceRunning=true;
  t0 = Date.now() - elapsed;
  timer = setInterval(tick,100);
  qs('#btnStartChrono').disabled=true;
  qs('#btnPause').disabled=false;
  qs('#btnReset').disabled=false;
  qs('#backSetup').disabled=true; // pas de retour saisie pendant la course
}
function pause(){
  if(!running) return;
  running=false; clearInterval(timer);
  qs('#btnStartChrono').disabled=false;
  qs('#btnPause').disabled=true;
}
function reset(){
  pause();
  elapsed=0; clockEl.textContent='00:00.0'; qs('#btnReset').disabled=true;
  if(timeOver) return; // si temps fini, on ne rouvre pas
  session.laps=0; session.shots=[]; session.frac=0;
  zone2ShotsRemaining=0; renderAll(); hideEndBar(); resetAdviceHistory(); setAdvice("Respire calmement. Reste concentr√©.");
  updateZoneVisuals();
}
function tick(){
  elapsed=Date.now()-t0;
  const cs=Math.floor(elapsed/100); const m=Math.floor(cs/600), s=Math.floor((cs%600)/10), d=cs%10;
  clockEl.textContent=`${m<10?'0':''}${m}:${s<10?'0':''}${s}.${d}`;
  if(m>=session.dureeMin){
    pause();
    timeOver=true;
    disableRaceInputs(true);
    showEndBar();
    setAdviceSmart('end');
  }
}

/* ================== UI header ================== */
const runnerTitle=qs('#runnerTitle'), metaRunner=qs('#metaRunner'), lapMetersEl=qs('#lapMeters'),
      lapsEl=qs('#laps'), liveDistanceEl=qs('#liveDistance'), zoneBadge=qs('#zoneBadge'), runnerBadge=qs('#runnerBadge');
function paintHeader(){
  const R=session[session.active];
  runnerTitle.textContent=`${R.prenom} ${R.nom}`;
  metaRunner.textContent=`${R.classe} ‚Ä¢ ${R.sexe}`;
  lapMetersEl.textContent=session.tourM;
  targetEl.textContent=session.dureeMin;
}
function paintRunnerBadge(){ const R=session[session.active]; runnerBadge.textContent = (R?.prenom || '‚Äî'); }

/* ================== Rendu & verrous ================== */
function renderAll(){ renderLaps(); renderAllowances(); renderShots(); renderSummaryCounters(); }
function disableRaceInputs(disabled){
  qs('#lapPlus').disabled  = disabled;
  qs('#lapMinus').disabled = disabled;
  document.querySelectorAll('#scoreButtons button').forEach(b=> b.disabled = disabled);
}

/* ================== Tours ================== */
qs('#lapPlus').onclick=()=>{ if(timeOver || !raceRunning) return showToast('Action indisponible.');
  const allowed=calcAllowedShots(); const pending=allowed-session.shots.length;
  if(pending>0){ showToast(`D'abord tirer ${pending} fl√®che${pending>1?'s':''}`); return; } session.laps++; renderAll(); };
qs('#lapMinus').onclick=()=>{ if(timeOver || !raceRunning) return showToast('Action indisponible.');
  session.laps=Math.max(0,session.laps-1); renderAll(); };
function renderLaps(){ lapsEl.textContent=session.laps; liveDistanceEl.textContent=Math.round((session.laps+(session.frac||0))*session.tourM); }

/* ================== R√®gles Tours ‚Üí Fl√®ches ================== */
function calcAllowedShots(){ const {tb,fb}=session.rules; const blocs=Math.floor(session.laps/tb); return blocs*fb; }
const allowedEl=qs('#allowed'), shotCountEl=qs('#shotCount'), remainEl=qs('#remain'), remainChip=qs('#remainChip');
function renderAllowances(){
  const allowed=calcAllowedShots(); const remain=Math.max(0,allowed-session.shots.length);
  allowedEl.textContent=allowed; shotCountEl.textContent=session.shots.length; remainEl.textContent=remain;
  if(remain>0) remainChip.classList.add('glow'); else remainChip.classList.remove('glow');
  qs('#lapPlus').disabled = (remain>0) || timeOver;
}

/* ================== Tir + Zone 2 (3 fl√®ches) ================== */
const shotsTable=qs('#shotsTable');
document.querySelectorAll('#scoreButtons [data-score]').forEach(btn=>{
  btn.onclick=()=>{
    if(timeOver || !raceRunning) return showToast('Action indisponible.');
    const allowed=calcAllowedShots();
    if(session.shots.length>=allowed){
      const need = session.rules.tb - (session.laps % session.rules.tb || session.rules.tb);
      showToast(`Pas assez de tours : +${need} tour${need>1?'s':''}`); return;
    }
    const score=+btn.getAttribute('data-score');
    const fb=session.rules.fb;

    addShot(score);
    setAdviceSmart('shot');

    // Consommer Z2 si actif
    if(zone2ShotsRemaining>0){
      zone2ShotsRemaining--;
      updateZoneVisuals();
    }

    // Fin de vol√©e -> √©valuer aide pour la prochaine vol√©e (programmation Z2)
    if(session.shots.length % fb === 0){
      maybeScheduleAssistForNextVolley();
    }
  };
});
function addShot(score){
  session.shots.push({n:session.shots.length+1, score});
  renderShots(); renderAllowances(); renderSummaryCounters();
}
function renderShots(){
  shotsTable.innerHTML='';
  [...session.shots].slice().reverse().forEach(s=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${s.n}</td><td>${s.score}</td><td><button class="b-red btn-lg">Retirer</button></td>`;
    tr.querySelector('button').onclick=()=>{
      if(timeOver || !raceRunning) return showToast('Action indisponible.');
      session.shots=session.shots.filter(x=>x.n!==s.n).map((x,i)=>({n:i+1,score:x.score}));
      renderShots(); renderAllowances(); renderSummaryCounters();
    };
    shotsTable.append(tr);
  });
}
function maybeScheduleAssistForNextVolley(){
  const fb=session.rules.fb; if(!ASSIST_ENABLED || fb<=0) return;
  const lastVolley = session.shots.slice(-fb);
  const zeros = lastVolley.filter(s=>s.score===0).length;
  const sum   = lastVolley.reduce((a,b)=>a+b.score,0);
  const needAssist = (zeros>=ASSIST_THR_ZEROS) || (sum<=ASSIST_THR_SUM);
  zone2ShotsRemaining = needAssist ? fb : 0; // 3 fl√®ches en Z2 si besoin
  updateZoneVisuals();
}
function updateZoneVisuals(){
  zoneBadge.textContent = 'Zone 1';
  const z2 = qs('#zone2Banner');
  if(zone2ShotsRemaining>0){ z2.classList.remove('hidden'); z2.removeAttribute('hidden'); }
  else { z2.classList.add('hidden'); z2.setAttribute('hidden',''); }
}

/* ================== Indice & compteurs ================== */
const c0El=qs('#c0'), c6El=qs('#c6'), c7El=qs('#c7'), c8El=qs('#c8'), c9El=qs('#c9'), c10El=qs('#c10'), indiceArcEl=qs('#indiceArc');
function scoreCounts(){ const c={0:0,6:0,7:0,8:0,9:0,10:0}; session.shots.forEach(s=>{ if(c.hasOwnProperty(s.score)) c[s.score]++; }); return c; }
function sumScores(){ return session.shots.reduce((a,b)=> a + ((b&&b.score)||0), 0); }
function computeIndiceArc(){ const T=session.shots.length; if(!T) return 0; const avg=sumScores()/T; return +(avg*10).toFixed(2); }
function renderSummaryCounters(){ const c=scoreCounts();
  c0El.textContent=c[0]; c6El.textContent=c[6]; c7El.textContent=c[7]; c8El.textContent=c[8]; c9El.textContent=c[9]; c10El.textContent=c[10];
  indiceArcEl.textContent=computeIndiceArc(); }

/* ================== Conseils ================== */
const adviceTxt=qs('#adviceTxt'); const ADVICE_COOLDOWN_EVENTS=3; const adviceHistory=[];
const ADICT={ breath:"Respire calmement.", breath5:"Ferme les yeux, 5 respirations.", anchor:"Tiens mieux ton arc.", routine:"Refais pareil.", tempo:"Prends ton temps.", hydrate:"Bois un peu.", focus:"Reste concentr√©." };
function pushAdviceTypeOnce(type, bag){ if(!type) return; if(adviceHistory.slice(-ADVICE_COOLDOWN_EVENTS).includes(type)) return; bag.push(type); }
function buildAdviceTypes(context){
  const types=[]; const T=session.shots.length; const indice=computeIndiceArc();
  if(context==='shot' && T>0){ const last=session.shots[T-1].score;
    if(last===0){ if(T===1) pushAdviceTypeOnce('breath5',types); else pushAdviceTypeOnce('breath',types); pushAdviceTypeOnce('anchor',types); }
    else if(last<=6){ pushAdviceTypeOnce('anchor',types); pushAdviceTypeOnce('tempo',types); }
    else if(last<=8){ pushAdviceTypeOnce('focus',types); }
    else { pushAdviceTypeOnce('routine',types); }
  }
  if(indice<40) pushAdviceTypeOnce('breath',types); else if(indice<70) pushAdviceTypeOnce('focus',types); else pushAdviceTypeOnce('routine',types);
  if(context==='end'){ pushAdviceTypeOnce('hydrate',types); }
  if(types.length===0) pushAdviceTypeOnce('focus',types);
  return types;
}
function setAdvice(t){ adviceTxt.textContent = (t&&t.trim())? t : '‚Äî'; }
function setAdviceSmart(context){ const types=buildAdviceTypes(context); types.forEach(t=>adviceHistory.push(t)); while(adviceHistory.length>20) adviceHistory.shift(); const max=(context==='end')?3:2; setAdvice(types.slice(0,max).map(t=>ADICT[t]).join(' ')); }
function resetAdviceHistory(){ adviceHistory.length = 0; }

/* ================== Fin de temps : bandeau ================== */
const endBar=qs('#endBar'), endActionBtn=qs('#endAction'), distanceOut=qs('#distanceOut');
document.querySelectorAll('[data-frac]').forEach(b=> b.onclick=()=>{ if(!timeOver) return; session.frac=+b.getAttribute('data-frac'); updateDistanceOut(); });
function showEndBar(){ endBar.classList.remove('hidden'); endBar.removeAttribute('hidden'); updateDistanceOut();
  endActionBtn.textContent = (phase==='runner1') ? '‚û°Ô∏è Course 2' : 'üìä Voir le bilan';
  if(navigator.vibrate) navigator.vibrate(120);
}
function hideEndBar(){ endBar.classList.add('hidden'); endBar.setAttribute('hidden',''); }
function updateDistanceOut(){ const meters=Math.round((session.laps+(session.frac||0))*session.tourM); distanceOut.textContent=`Distance : ${meters} m`; }

endActionBtn.onclick = ()=>{
  if(phase === 'runner1'){
    finalizeRunnerPartial(); phase = 'runner2'; prepareNextRunner('p2');
  }else{
    finalizeRunnerPartial(); phase = 'done'; buildSummaryFromResults(); show('summary'); renderSummary();
  }
};

function finalizeRunnerPartial(){
  const R=session[session.active]; const meters=Math.round((session.laps+(session.frac||0))*session.tourM);
  const c=scoreCounts(); const indice=computeIndiceArc();
  session.results[session.active]={ prenom:R.prenom, nom:R.nom, classe:R.classe, sexe:R.sexe, distance:meters,
    nb0:c[0], nb6:c[6], nb7:c[7], nb8:c[8], nb9:c[9], nb10:c[10], indice_arc:indice };
}

function prepareNextRunner(which){
  session.active=which;
  resetAdviceHistory();
  raceRunning=false; timeOver=false; running=false; clearInterval(timer); elapsed=0; clockEl.textContent='00:00.0';
  session.laps=0; session.shots=[]; session.frac=0; zone2ShotsRemaining=0;
  disableRaceInputs(false);
  hideEndBar();
  qs('#btnStartChrono').disabled=false; qs('#btnPause').disabled=true; qs('#btnReset').disabled=true;
  qs('#backSetup').disabled=true;
  paintHeader(); paintRunnerBadge(); renderAll(); updateZoneVisuals(); setAdvice("Respire calmement. Reste concentr√©.");
}

/* ================== R√©sum√© / QR / CSV ================== */
let summaryData=[];
function buildSummaryFromResults(){ const out=[]; if(session.results.p1) out.push({...session.results.p1}); if(session.results.p2) out.push({...session.results.p2}); summaryData=out; }

function buildQrData(rows){ return rows.map(d=>({nom:d.nom, prenom:d.prenom, classe:d.classe, sexe:d.sexe,
  distance:d.distance, nb0:d.nb0, nb6:d.nb6, nb7:d.nb7, nb8:d.nb8, nb9:d.nb9, nb10:d.nb10, indice_arc:d.indice_arc })); }
function buildQR(payload){ const box=qs('#qr'); box.innerHTML=''; try{ if(window.QRCode){ new QRCode(box,{ text:payload, width:256, height:256, correctLevel:QRCode.CorrectLevel.M }); } }catch(e){ console.warn('QR non g√©n√©r√©',e); } }
function toCSV(data){ const H=['nom','prenom','classe','sexe','distance','nb0','nb6','nb7','nb8','nb9','nb10','indice_arc'];
  const esc=v=>{ const s=(v==null?'':String(v)); return /[;\"\n]/.test(s)? `"${s.replace(/\"/g,'""')}"` : s; };
  return [H.join(';'), ...data.map(d=>H.map(h=>esc(d[h])).join(';'))].join('\n'); }
function renderSummary(){
  const rows = summaryData.map((d,i)=>`
    <tr data-index="${i}">
      <td>${d.nom}</td>
      <td>${d.prenom}</td>
      <td>${d.classe}</td>
      <td>${d.sexe}</td>
      <td>${d.distance}</td>
      <td>${d.nb0}</td>
      <td>${d.nb6}</td>
      <td>${d.nb7}</td>
      <td>${d.nb8}</td>
      <td>${d.nb9}</td>
      <td>${d.nb10}</td>
      <td>${d.indice_arc}</td>
    </tr>`).join('');
  qs('#resume').innerHTML = `
    <details open>
      <summary>Tableau r√©capitulatif</summary>
      <div style="overflow:auto; margin-top:8px">
        <table>
          <thead><tr>
            <th>Nom</th><th>Pr√©nom</th><th>Classe</th><th>Sexe</th>
            <th>Distance (m)</th><th>Nb 0</th><th>Nb 6</th><th>Nb 7</th><th>Nb 8</th><th>Nb 9</th><th>Nb 10</th>
            <th>Indice (%)</th>
          </tr></thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    </details>`;
  const payloadQR = JSON.stringify(buildQrData(summaryData)); buildQR(payloadQR);
  qs('#exportCsv').onclick=()=>{ const csv=toCSV(summaryData); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a');
    a.href=url; a.download=`ArcAthlon_${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); };
}
qs('#backToCourse').onclick=()=> show('course');

/* ================== Init ================== */
function resetRunnerState(hard=false){
  if(hard){
    running=false; clearInterval(timer); elapsed=0; clockEl.textContent='00:00.0';
    qs('#btnStartChrono').disabled=false; qs('#btnPause').disabled=true; qs('#btnReset').disabled=true;
  }
  session.laps=0; session.shots=[]; session.frac=0; zone2ShotsRemaining=0;
  disableRaceInputs(false); hideEndBar(); resetAdviceHistory(); setAdvice("Respire calmement. Reste concentr√©.");
  updateZoneVisuals(); renderAll();
}
validate(); setAdvice("Respire calmement. Reste concentr√©.");
try{ console.assert(!!V.cover && !!V.setup && !!V.course && !!V.summary, 'vues ok'); }catch(_){}
</script>
</body>
</html>
