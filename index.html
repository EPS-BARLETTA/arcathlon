<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ArcAthlon-V2 ‚Äî Compact Gym V2.5</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f6f8fb; --card:#fff; --ink:#0b1220; --muted:#6b7280; --primary:#0a58ff;
    --green:#22c55e; --amber:#f59e0b; --red:#ef4444; --slate:#334155;
    --ring:0 10px 40px rgba(2,6,23,.08); --radius:18px;
    --adviceRing:#c7d2fe; --adviceBg:#eef2ff; --adviceBadge:#4338ca;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; background:var(--bg); color:var(--ink); font:17px/1.35 Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; display:flex; flex-direction:column;}
  .wrap{max-width:980px; margin:0 auto; padding:16px; width:100%}
  h1,h2,h3{margin:0 0 10px; text-align:center}
  h1{font-size:clamp(24px,4vw,36px); font-weight:800}
  h2{font-size:clamp(20px,3vw,28px); font-weight:800}
  h3{font-size:clamp(18px,2.6vw,22px); font-weight:800}
  p{margin:6px 0; color:var(--muted)}
  .card{background:var(--card); border-radius:var(--radius); box-shadow:var(--ring); padding:14px}
  .hidden{display:none!important}

  .btns{display:flex; gap:12px; flex-wrap:wrap; justify-content:center; align-items:center}
  button{border:0; border-radius:16px; font-weight:800; cursor:pointer}
  .btn-xl{padding:18px 20px; font-size:20px}
  .btn-lg{padding:16px 18px; font-size:18px}
  .btn-xxl{padding:22px 26px; font-size:28px}
  .b-primary{background:var(--primary); color:#fff}
  .b-green{background:var(--green); color:#fff}
  .b-amber{background:var(--amber); color:#111}
  .b-red{background:var(--red); color:#fff}
  .b-slate{background:var(--slate); color:#fff}
  .b-ghost{background:#eef2f7; color:#0b1220}

  label{display:block; font-weight:800; margin:8px 0 6px}
  input,select{width:100%; padding:14px 16px; border:2px solid #e5e7eb; border-radius:14px; background:#fff; font:inherit}
  input[type=number]{appearance:textfield}

  .grid{display:grid; gap:12px}
  .g2{grid-template-columns:1fr 1fr}
  @media (max-width:720px){ .g2{grid-template-columns:1fr} }

  .hero{display:flex; align-items:center; justify-content:center; min-height:50vh; text-align:center}
  .chrono{display:flex; align-items:center; justify-content:center; gap:12px; flex-wrap:wrap}
  .time{font-size:clamp(44px,9vw,78px); font-weight:900; letter-spacing:1px}
  .pill{display:inline-block; padding:6px 12px; border-radius:999px; background:#eef2f7; font-weight:800}

  .bigNum{font-size:48px; font-weight:900}
  .kpi{display:flex; gap:10px; justify-content:center; flex-wrap:wrap}
  .kchip{padding:8px 12px; border-radius:12px; font-weight:800}
  /* Couleurs demand√©es pour Autoris√©es / Tir√©es / Restantes */
  .kchip.allowed{background:#dbeafe; color:#0b1220;}   /* bleu clair */
  .kchip.shot{background:#ede9fe; color:#111827;}      /* violet clair */
  .kchip.remain{background:#dcfce7; color:#065f46;}    /* vert clair */
  .glow{animation:pulse 1s infinite alternate}
  @keyframes pulse{from{box-shadow:0 0 0 rgba(34,197,94,0)} to{box-shadow:0 0 18px rgba(34,197,94,.55)}}

  .shot-grid{display:grid; grid-template-columns:repeat(6,1fr); gap:10px}
  .shot-grid button{padding:16px 0; font-size:22px; border-radius:14px; font-weight:900}

  .advice{margin-top:10px; border:2px solid var(--adviceRing); background:var(--adviceBg); border-radius:16px; padding:12px 14px; text-align:center}
  .ad-badge{display:inline-block; padding:4px 10px; border-radius:999px; font-weight:800; color:#fff; background:var(--adviceBadge); font-size:14px}
  .ad-text{margin-top:6px; font-size:18px; color:#0b1220; font-weight:800}

  details{background:#f8fafc; border:1px dashed #dbe1ea; border-radius:12px; padding:8px 10px}
  details > summary{cursor:pointer; font-weight:800; margin:6px 0}
  table{width:100%; border-collapse:collapse}
  th,td{padding:10px; border-bottom:1px solid #e5e7eb; text-align:center}

  .toast{ position:fixed; left:50%; bottom:84px; transform:translateX(-50%); background:#111827; color:#fff; padding:10px 14px; border-radius:10px;
    box-shadow:0 10px 30px rgba(2,6,23,.35); font-weight:800; z-index:70; opacity:0; pointer-events:none; transition:opacity .2s, transform .2s; max-width:92vw; text-align:center}
  .toast.show{opacity:1; transform:translateX(-50%) translateY(-6px)}

  .banner{background:#fff7ed; border:2px dashed #f59e0b; color:#7c2d12; border-radius:12px; padding:8px 10px; text-align:center; font-weight:800}
  .banner.ok{background:#ecfeff; border-color:#06b6d4; color:#155e75}

  .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:80;
    background:linear-gradient(180deg,rgba(2,6,23,.55),rgba(2,6,23,.35));}
  .modal.show{display:flex;}
  .modal-card{background:#fff; border-radius:20px; max-width:900px; width:92%; overflow:hidden; box-shadow:0 12px 48px rgba(2,6,23,.25)}
  .modal-head{display:flex; align-items:center; gap:12px; padding:16px 18px; color:#fff; font-weight:800}
  .modal-head.help{background:linear-gradient(90deg,#0a58ff,#7c3aed)}
  .modal-head.safe{background:linear-gradient(90deg,#22c55e,#0ea5e9)}
  .modal-head.indice{background:linear-gradient(90deg,#111827,#0a58ff)}
  .modal-head.prof{background:linear-gradient(90deg,#0a58ff,#22c55e)}
  .modal-body{padding:18px}
  .modal-body h4{margin:12px 0 6px}
  .help-list{margin:8px 0 12px; line-height:1.55}
  .help-list li{margin:6px 0}

  .confirmbar{display:flex; gap:8px; justify-content:center; align-items:center; flex-wrap:wrap; margin-top:8px}
  .confirmbar .mini{padding:8px 10px; font-size:16px; border-radius:10px}

  /* Centrage et style des boutons pr√©noms */
  .runner-switch{display:flex; justify-content:center; gap:12px; flex-wrap:wrap}
  .runner-switch .btn-lg{min-width:240px; text-transform:uppercase; letter-spacing:.3px}

  footer{margin-top:auto; padding:10px; text-align:center; color:var(--muted)}
</style>
</head>
<body>
  <div class="wrap">
    <!-- ACCUEIL -->
    <section id="view-cover" class="card hero">
      <div style="width:100%; max-width:640px; margin:0 auto;">
        <h1>ArcAthlon-V2</h1>
        <p class="muted">EPS ‚Ä¢ ScanProf ready</p>

        <!-- D√©marrer sous le titre -->
        <div class="btns" style="margin-top:14px">
          <button id="btnStartApp" class="b-primary btn-xxl">‚ñ∂Ô∏è D√©marrer</button>
        </div>
        <!-- Autres boutons en dessous -->
        <div class="btns" style="margin-top:10px">
          <button id="btnHelp" class="b-slate btn-lg">‚ÑπÔ∏è Aide</button>
          <button id="btnSafety" class="b-ghost btn-lg">üõü Fiche s√©curit√©</button>
          <button id="btnIndice" class="b-ghost btn-lg">üéØ Indice arc</button>
          <button id="btnProf" class="b-ghost btn-lg">‚öôÔ∏è Param√®tres Prof</button>
        </div>
      </div>
    </section>

    <!-- SAISIE -->
    <section id="view-setup" class="card hidden">
      <h2>Param√®tres & coureurs</h2>
      <div class="grid g2">
        <div>
          <h3>Coureur 1</h3>
          <label>Pr√©nom</label><input id="p1_prenom" autocomplete="off">
          <label>Nom</label><input id="p1_nom" autocomplete="off">
          <label>Classe</label><input id="p1_classe" autocomplete="off">
          <label>Sexe</label>
          <select id="p1_sexe"><option value="">‚Äî</option><option>F</option><option>M</option></select>
        </div>
        <div>
          <h3>Coureur 2</h3>
          <label>Pr√©nom</label><input id="p2_prenom" autocomplete="off">
          <label>Nom</label><input id="p2_nom" autocomplete="off">
          <label>Classe</label><input id="p2_classe" autocomplete="off">
          <label>Sexe</label>
          <select id="p2_sexe"><option value="">‚Äî</option><option>F</option><option>M</option></select>
        </div>
      </div>

      <div class="grid g2" style="margin-top:8px">
        <div>
          <label>Dur√©e (minutes)</label>
          <input id="duree_min" type="number" min="1" step="1" placeholder="ex. 8">
        </div>
        <div>
          <label>Longueur d‚Äôun tour (m)</label>
          <input id="tour_m" type="number" min="10" step="1" placeholder="ex. 200">
        </div>
      </div>

      <div class="grid g2" style="margin-top:8px">
        <div>
          <label>Tours par bloc</label>
          <input id="tours_bloc" type="number" min="1" step="1" value="3">
        </div>
        <div>
          <label>Fl√®ches par bloc</label>
          <input id="fleches_bloc" type="number" min="1" step="1" value="3">
        </div>
      </div>

      <div class="btns" style="margin-top:8px">
        <button class="b-slate btn-lg" id="preset33">3 tours ‚Üí 3 fl√®ches</button>
        <button class="b-slate btn-lg" id="preset11">1 tour ‚Üí 1 fl√®che</button>
        <button class="b-slate btn-lg" id="preset13">1 tour ‚Üí 3 fl√®ches</button>
        <button id="openProfFromSetup" class="b-ghost btn-lg">‚öôÔ∏è Param√®tres Prof</button>
      </div>

      <div class="btns" style="margin-top:10px">
        <button id="goCourse" class="b-primary btn-xl" disabled>Acc√©der √† la course</button>
        <button id="goHome" class="b-slate btn-lg">üè† Accueil</button>
      </div>
    </section>

    <!-- COURSE -->
    <section id="view-course" class="hidden">
      <div class="card">
        <div class="btns" style="justify-content:space-between; gap:8px">
          <button id="backSetup" class="b-slate btn-lg">‚¨Ö Saisie</button>
          <span class="pill" id="metaRunner">‚Äî</span>
        </div>
        <h2 id="runnerTitle">Coureur ‚Äî </h2>

        <div class="btns" style="margin:6px 0">
          <span class="pill" id="zoneBadge">Zone actuelle : Zone 1</span>
        </div>

        <!-- Chrono -->
        <div class="chrono card" style="margin-top:6px">
          <div class="time" id="clock">00:00.0</div>
          <div class="btns">
            <button id="btnStartChrono" class="b-primary btn-xxl">‚ñ∂Ô∏è D√©marrer</button>
            <button id="btnPause" class="b-amber btn-lg" disabled>‚è∏Ô∏è</button>
            <button id="btnReset" class="b-red btn-lg" disabled>‚Ü∫</button>
          </div>
        </div>
        <p class="muted" style="text-align:center">Dur√©e cible : <b id="target"></b> min</p>

        <!-- Switch coureurs (pr√©noms) -->
        <div class="runner-switch" style="margin:8px 0">
          <button id="pickP1" class="b-green btn-lg">üëü Coureur 1</button>
          <button id="pickP2" class="b-green btn-lg">üëü Coureur 2</button>
          <label style="margin-left:auto"><input type="checkbox" id="assist_blocked_live"> Bloquer auto-aide</label>
        </div>

        <!-- Banni√®res auto-aide -->
        <div id="assistBannerNext" class="banner hidden">Prochaine vol√©e : Zone 2 (aide)</div>
        <!-- Toujours visible : refl√®te la zone de la VOL√âE en cours -->
        <div id="assistBannerNow" class="banner ok">Vol√©e en Zone 1</div>
        <div id="assistConfirm" class="confirmbar hidden">
          <span class="pill">Confirmer Zone 2 ?</span>
          <button id="assistYes" class="b-green mini">‚úîÔ∏è Appliquer</button>
          <button id="assistNo" class="b-slate mini">‚úñÔ∏è Ignorer</button>
        </div>
      </div>

      <div class="grid g2" style="margin-top:10px">
        <!-- Tours -->
        <div class="card">
          <h3>Tours</h3>
          <div class="bigNum" id="laps">0</div>
          <div class="kpi">
            <span class="kchip">1 tour = <b id="lapMeters">‚Äî</b> m</span>
            <span class="kchip">Distance : <b id="liveDistance">0</b> m</span>
          </div>
          <div class="btns" style="margin-top:8px">
            <button id="lapPlus" class="b-green btn-xl">+1 tour</button>
            <button id="lapMinus" class="b-slate btn-lg">‚àí1</button>
          </div>
        </div>

        <!-- Tir -->
        <div class="card">
          <h3>Tir (0,6,7,8,9,10)</h3>
          <div class="kpi" style="margin-bottom:6px">
            <span class="kchip allowed">Autoris√©es : <b id="allowed">0</b></span>
            <span class="kchip shot">Tir√©es : <b id="shotCount">0</b></span>
            <span class="kchip remain" id="remainChip">Restantes : <b id="remain">0</b></span>
            <span class="kchip">Indice : <b id="indiceArc">0</b>%</span>
          </div>

          <!-- Conseil -->
          <div class="advice" id="adviceBox">
            <span class="ad-badge">Conseil</span>
            <div class="ad-text" id="adviceTxt">‚Äî</div>
          </div>

          <div class="shot-grid" id="scoreButtons" style="margin-top:8px">
            <button class="b-slate" data-score="0">0</button>
            <button class="b-slate" data-score="6">6</button>
            <button class="b-slate" data-score="7">7</button>
            <button class="b-slate" data-score="8">8</button>
            <button class="b-slate" data-score="9">9</button>
            <button class="b-slate" data-score="10">10</button>
          </div>

          <details style="margin-top:10px">
            <summary>Voir d√©tails & compteurs</summary>
            <div class="kpi" style="margin-top:6px">
              <span class="kchip">Nb 10 : <b id="c10">0</b></span>
              <span class="kchip">Nb 9 : <b id="c9">0</b></span>
              <span class="kchip">Nb 8 : <b id="c8">0</b></span>
              <span class="kchip">Nb 7 : <b id="c7">0</b></span>
              <span class="kchip">Nb 6 : <b id="c6">0</b></span>
              <span class="kchip">Nb 0 : <b id="c0">0</b></span>
            </div>
            <div style="overflow:auto; margin-top:6px">
              <table>
                <thead><tr><th>#</th><th>Score</th><th>Action</th></tr></thead>
                <tbody id="shotsTable"></tbody>
              </table>
            </div>
          </details>
        </div>
      </div>

      <div class="card hidden" id="endCard" style="margin-top:10px; text-align:center">
        <h3>‚è±Ô∏è Temps √©coul√© ‚Äî fraction de tour</h3>
        <div class="btns" style="margin-top:6px">
          <button class="b-slate btn-lg" data-frac="0">+ 0</button>
          <button class="b-slate btn-lg" data-frac="0.25">+ 1/4</button>
          <button class="b-slate btn-lg" data-frac="0.5">+ 1/2</button>
          <button class="b-slate btn-lg" data-frac="0.75">+ 3/4</button>
          <button class="b-green btn-xl" id="finishRunner">‚úÖ Terminer</button>
        </div>
        <p class="muted" id="distanceOut">Distance : ‚Äî m</p>
      </div>

      <div class="btns hidden" id="toSummaryWrap" style="margin:10px 0">
        <button class="b-primary btn-xl" id="goSummary">üìä Bilan</button>
      </div>
    </section>

    <!-- BILAN / QR -->
    <section id="view-summary" class="card hidden" style="text-align:center">
      <h2>Bilan ‚Äî QR compatible ScanProf</h2>
      <div id="qr" class="card" style="display:inline-block"></div>

      <div class="card" style="margin-top:8px">
        <div class="btns" style="flex-wrap:wrap">
          <input id="profCode" type="password" inputmode="numeric" placeholder="Code Prof" style="min-width:200px">
          <button class="b-slate btn-lg" id="activateProf">üîì Activer</button>
          <button class="b-amber btn-lg" id="deactivateProf" disabled>üîí D√©sactiver</button>
          <button class="b-green btn-lg" id="applyEdits" disabled>üíæ Mettre √† jour</button>
          <button class="b-primary btn-lg" id="exportCsv">‚¨áÔ∏è Export CSV</button>
        </div>
        <p class="muted" id="profHint" style="margin-top:6px"></p>
      </div>

      <div id="resume" style="margin-top:8px"></div>

      <div class="btns" style="margin-top:10px">
        <button class="b-slate btn-lg" id="backToCourse">‚¨Ö Retour course</button>
        <button class="b-green btn-lg" id="backHome2">üè† Accueil</button>
      </div>
    </section>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <footer>ArcAthlon - √âquipe EPS Lyc√©e Vauban - LUXEMBOURG - JB</footer>

  <!-- Modales info -->
  <div class="modal" id="modalHelp">
    <div class="modal-card">
      <div class="modal-head help"><span>‚ÑπÔ∏è</span><span>Mode d‚Äôemploi ‚Äî ArcAthlon-V2</span></div>
      <div class="modal-body">
        <ol class="help-list">
          <li>Saisir pour chaque √©l√®ve : <strong>Pr√©nom</strong>, <strong>Nom</strong>, <strong>Classe</strong>, <strong>Sexe</strong>.</li>
          <li>R√©gler <strong>Dur√©e</strong>, <strong>Longueur tour</strong>, et la r√®gle <strong>Tours ‚Üí Fl√®ches</strong>.</li>
          <li>En course : <strong>Start/Pause</strong> le chrono ; <strong>+1 / ‚àí1</strong> pour les tours.</li>
          <li>Le tir est d√©bloqu√© par <strong>blocs</strong> (selon la r√®gle). Scores : <b>0,6,7,8,9,10</b>.</li>
          <li>Fin du temps : compl√©ter la <strong>fraction de tour</strong>, valider, puis g√©n√©rer <strong>QR</strong> et <strong>CSV</strong>.</li>
        </ol>
        <div class="btns"><button class="b-slate btn-lg" data-close>Fermer</button></div>
      </div>
    </div>
  </div>

  <div class="modal" id="modalSafety">
    <div class="modal-card">
      <div class="modal-head safe"><span>üõü</span><span>Fiche s√©curit√©</span></div>
      <div class="modal-body">
        <h4>Avant l‚Äôactivit√©</h4>
        <ul class="help-list">
          <li>Zone de course d√©gag√©e ; surface adh√©rente ; pas d‚Äôobstacles.</li>
          <li>Pas de tir mat√©rialis√© + zone d‚Äôattente.</li>
          <li>Contr√¥ler arcs/fl√®ches (branches, corde, empennage, pointes).</li>
        </ul>
        <h4>Au pas de tir</h4>
        <ul class="help-list">
          <li>Arc vers les cibles ; on tire <strong>uniquement</strong> sur signal.</li>
          <li>Personne devant la ligne ; on pose l‚Äôarc √† l‚Äôarr√™t.</li>
        </ul>
        <h4>R√©cup√©ration</h4>
        <ul class="help-list">
          <li>Sur signal ; on marche, pas de course devant la cible.</li>
          <li>Retirer la fl√®che dans l‚Äôaxe, main sur la cible.</li>
        </ul>
        <div class="btns"><button class="b-slate btn-lg" data-close>Fermer</button></div>
      </div>
    </div>
  </div>

  <div class="modal" id="modalIndice">
    <div class="modal-card">
      <div class="modal-head indice"><span>üéØ</span><span>Indice arc ‚Äî explication</span></div>
      <div class="modal-body">
        <p><strong>But :</strong> mesurer la pr√©cision de 0 √† 100%.</p>
        <p><strong>Scores par fl√®che :</strong> 0, 6, 7, 8, 9, 10.</p>
        <p><strong>Calcul :</strong> moyenne des points sur 10, puis sur 100.</p>
        <ul class="help-list">
          <li>Total fl√®ches T = nb0 + nb6 + nb7 + nb8 + nb9 + nb10</li>
          <li>Total points P = 6√ónb6 + 7√ónb7 + 8√ónb8 + 9√ónb9 + 10√ónb10</li>
          <li><b>Indice (%) = (P / T) √∑ 10 √ó 100</b></li>
        </ul>
        <div class="btns"><button class="b-slate btn-lg" data-close>Fermer</button></div>
      </div>
    </div>
  </div>

  <!-- Modal Param√®tres Prof -->
  <div class="modal" id="modalProf">
    <div class="modal-card">
      <div class="modal-head prof"><span>‚öôÔ∏è</span><span>Param√®tres Prof ‚Äî ArcAthlon-V2</span></div>
      <div class="modal-body">
        <div id="profGate">
          <p><b>Code Prof</b> requis :</p>
          <div class="btns">
            <input id="profCodeGate" type="password" inputmode="numeric" placeholder="Code Prof" style="min-width:220px">
            <button id="profUnlock" class="b-slate btn-lg">üîì D√©verrouiller</button>
          </div>
          <p class="muted">Astuce : ce param√©trage s‚Äôapplique √† la prochaine session (jusqu‚Äôau rechargement).</p>
        </div>
        <div id="profPanel" class="hidden">
          <h4>Auto-aide ‚ÄúZone 2‚Äù</h4>
          <div class="grid g2">
            <div>
              <label><input type="checkbox" id="cfg_enabled" checked> Activer l‚Äôauto-aide</label>
            </div>
            <div>
              <label>Seuil de z√©ros / vol√©e (‚â•)</label>
              <input id="cfg_thrZeros" type="number" min="1" step="1" value="3">
            </div>
          </div>
          <div class="grid g2" style="margin-top:6px">
            <div>
              <label>Seuil points / vol√©e (‚â§)</label>
              <input id="cfg_thrSum" type="number" min="0" step="1" value="20">
            </div>
            <div>
              <label><input type="checkbox" id="cfg_manual"> Confirmation manuelle (Appliquer/Ignorer)</label>
            </div>
          </div>
          <div class="btns" style="margin-top:10px">
            <button id="profSave" class="b-green btn-lg">üíæ Enregistrer</button>
            <button class="b-slate btn-lg" data-close>Fermer</button>
          </div>
          <p class="muted">La Zone 2 s‚Äôapplique pour <b>une seule vol√©e</b> (3 fl√®ches), puis retour en Zone 1.</p>
        </div>
      </div>
    </div>
  </div>

  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"
          onerror="window.QRCode=undefined"></script>

<script>
'use strict';

/* ================== R√©glages ================== */
const PROF_CODE = '57'; // code prof

/* ================== Helpers ================== */
const qs = sel => document.querySelector(sel);
const V = { cover: qs('#view-cover'), setup: qs('#view-setup'), course: qs('#view-course'), summary: qs('#view-summary') };
function show(name){ Object.values(V).forEach(v=>v.classList.add('hidden')); V[name].classList.remove('hidden'); window.scrollTo(0,0); }
function showToast(msg, ms=1600){ const t=qs('#toast'); t.textContent=msg; t.classList.add('show'); clearTimeout(showToast.t); showToast.t=setTimeout(()=>t.classList.remove('show'),ms); }

/* ================== Modales ================== */
function openModal(id){ qs('#'+id).classList.add('show'); }
function closeModals(){ document.querySelectorAll('.modal').forEach(m=>m.classList.remove('show')); }
document.addEventListener('click', (e)=>{ if(e.target.matches('[data-close]')) closeModals(); });
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModals(); });

/* Boutons modales/info */
qs('#btnHelp').onclick   = ()=> openModal('modalHelp');
qs('#btnSafety').onclick = ()=> openModal('modalSafety');
qs('#btnIndice').onclick = ()=> openModal('modalIndice');
qs('#btnProf').onclick   = ()=> openModal('modalProf');
qs('#openProfFromSetup').onclick = ()=> openModal('modalProf');

/* ================== Navigation ================== */
qs('#btnStartApp').onclick = ()=> show('setup');
qs('#goHome').onclick      = ()=> show('cover');
qs('#backSetup').onclick   = ()=> show('setup');
qs('#backHome2').onclick   = ()=> show('cover');

/* ================== Validation saisie (Sexe obligatoire) ================== */
function clean(s){ return (s||'').replace(/\s+/g,' ').trim(); }
function val(id){ return clean(document.getElementById(id).value); }
function okNum(v,min){ const n=+v; return Number.isFinite(n) && n>=min; }
function mark(el, good){ el.style.borderColor = good ? '#e5e7eb' : '#ef4444'; }
function validate(){
  const req = ['p1_prenom','p1_nom','p1_classe','p1_sexe','p2_prenom','p2_nom','p2_classe','p2_sexe'];
  let ok = true;
  req.forEach(id=>{ const el=document.getElementById(id); const good=val(id).length>0; mark(el,good); ok=ok&&good; });
  ['duree_min','tour_m','tours_bloc','fleches_bloc'].forEach(id=>{
    const good = okNum(val(id), id==='tour_m'?10:1);
    mark(document.getElementById(id), good); ok = ok && good;
  });
  qs('#goCourse').disabled = !ok; return ok;
}
['p1_prenom','p1_nom','p1_classe','p1_sexe','p2_prenom','p2_nom','p2_classe','p2_sexe','duree_min','tour_m','tours_bloc','fleches_bloc']
.forEach(id=>{ const el=document.getElementById(id); el.addEventListener('input',validate); el.addEventListener('change',validate); });

/* Presets tours‚Üífl√®ches */
qs('#preset33').onclick = ()=>{ document.getElementById('tours_bloc').value=3; document.getElementById('fleches_bloc').value=3; validate(); };
qs('#preset11').onclick = ()=>{ document.getElementById('tours_bloc').value=1; document.getElementById('fleches_bloc').value=1; validate(); };
qs('#preset13').onclick = ()=>{ document.getElementById('tours_bloc').value=1; document.getElementById('fleches_bloc').value=3; validate(); };

/* ================== Stockage config prof (m√©moire simple) ================== */
const profConfig = {
  enabled: true,
  thrZeros: 3,
  thrSum: 20,
  manual: false
};
function applyProfPanelToConfig(){
  profConfig.enabled = qs('#cfg_enabled').checked;
  profConfig.thrZeros = Math.max(1, +qs('#cfg_thrZeros').value || 3);
  profConfig.thrSum   = Math.max(0, +qs('#cfg_thrSum').value || 20);
  profConfig.manual   = qs('#cfg_manual').checked;
}
function fillProfPanelFromConfig(){
  qs('#cfg_enabled').checked = profConfig.enabled;
  qs('#cfg_thrZeros').value  = profConfig.thrZeros;
  qs('#cfg_thrSum').value    = profConfig.thrSum;
  qs('#cfg_manual').checked  = profConfig.manual;
}

/* D√©verrouillage panel prof */
qs('#profUnlock').onclick = ()=>{
  const code = (qs('#profCodeGate').value||'').trim();
  if(code === String(PROF_CODE)){
    qs('#profGate').classList.add('hidden');
    qs('#profPanel').classList.remove('hidden');
    fillProfPanelFromConfig();
  }else{
    showToast('Code incorrect.');
  }
};
qs('#profSave').onclick = ()=>{
  applyProfPanelToConfig();
  showToast('Param√®tres Prof enregistr√©s.');
};

/* ================== Session ================== */
const session={
  p1:null, p2:null, tourM:0, dureeMin:0, rules:{tb:3,fb:3},
  active:'p1', laps:0, frac:0, shots:[], results:{p1:null,p2:null}, finished:false,
  assist:{enabled:true, thrZeros:3, thrSum:20, manual:false, blocked:false, nextVolley:false, currentVolley:false, pending:false}
};

qs('#goCourse').onclick=()=>{
  if(!validate()){ showToast('Compl√©tez tous les champs (dont Sexe).'); return; }
  function sex(id){ const s=(val(id)||'').toUpperCase(); return s==='M'?'M':'F'; }
  session.p1={ prenom:val('p1_prenom'), nom:val('p1_nom'), classe:val('p1_classe'), sexe:sex('p1_sexe') };
  session.p2={ prenom:val('p2_prenom'), nom:val('p2_nom'), classe:val('p2_classe'), sexe:sex('p2_sexe') };

  session.dureeMin=+val('duree_min'); session.tourM=+val('tour_m');
  session.rules.tb=+document.getElementById('tours_bloc').value;
  session.rules.fb=+document.getElementById('fleches_bloc').value;

  // Appliquer la config prof √† la session
  Object.assign(session.assist, {
    enabled: profConfig.enabled,
    thrZeros: profConfig.thrZeros,
    thrSum: profConfig.thrSum,
    manual: profConfig.manual,
    blocked: false, nextVolley:false, currentVolley:false, pending:false
  });
  qs('#assist_blocked_live').checked = false;

  // Pr√©noms sur boutons
  qs('#pickP1').textContent = 'üëü ' + session.p1.prenom;
  qs('#pickP2').textContent = 'üëü ' + session.p2.prenom;

  session.active='p1'; resetRunnerState(); paintHeader(); show('course');
};

/* ================== Chrono ================== */
const clockEl=qs('#clock'), targetEl=qs('#target');
let t0=0, elapsed=0, timer=null, running=false;
function start(){ if(session.finished||running) return; running=true; t0=Date.now()-elapsed; timer=setInterval(tick,100);
  qs('#btnStartChrono').disabled=true; qs('#btnPause').disabled=false; qs('#btnReset').disabled=false; }
function pause(){ if(!running) return; running=false; clearInterval(timer);
  qs('#btnStartChrono').disabled=false; qs('#btnPause').disabled=true; }
function reset(){ pause(); elapsed=0; clockEl.textContent='00:00.0'; qs('#btnReset').disabled=true;
  session.laps=0; session.shots=[]; session.frac=0;
  Object.assign(session.assist, {nextVolley:false, currentVolley:false, pending:false, blocked:false});
  renderAll(); hideEnd(); adviceHistory.length=0; setAdvice(''); banners(); updateZoneBadge(); }
function tick(){ elapsed=Date.now()-t0; const cs=Math.floor(elapsed/100); const m=Math.floor(cs/600), s=Math.floor((cs%600)/10), d=cs%10;
  clockEl.textContent=`${m<10?'0':''}${m}:${s<10?'0':''}${s}.${d}`; if(m>=session.dureeMin){ pause(); showEnd(); setAdviceSmart('end'); } }
qs('#btnStartChrono').onclick=start; qs('#btnPause').onclick=pause; qs('#btnReset').onclick=reset;

/* ================== UI header ================== */
const runnerTitle=qs('#runnerTitle'), metaRunner=qs('#metaRunner'), lapMetersEl=qs('#lapMeters'),
      lapsEl=qs('#laps'), liveDistanceEl=qs('#liveDistance'), zoneBadge=qs('#zoneBadge');
function paintHeader(){
  const R=session[session.active];
  runnerTitle.textContent=`${R.prenom} ${R.nom}`;
  metaRunner.textContent=`${R.classe} ‚Ä¢ ${R.sexe}`;
  lapMetersEl.textContent=session.tourM;
  targetEl.textContent=session.dureeMin;
}

/* ================== Runners switch ================== */
qs('#pickP1').onclick=()=> switchRunner('p1');
qs('#pickP2').onclick=()=> switchRunner('p2');
const temp={ p1:{laps:0,frac:0,shots:[], assist:{next:false,now:false,pending:false}}, p2:{laps:0,frac:0,shots:[], assist:{next:false,now:false,pending:false}} };
function saveTemp(){ temp[session.active]={ laps:session.laps, frac:session.frac, shots:JSON.parse(JSON.stringify(session.shots)), assist:{next:session.assist.nextVolley, now:session.assist.currentVolley, pending:session.assist.pending} }; }
function loadTemp(){ const t=temp[session.active]; session.laps=t.laps; session.frac=t.frac; session.shots=JSON.parse(JSON.stringify(t.shots)); session.assist.nextVolley=t.assist.next; session.assist.currentVolley=t.assist.now; session.assist.pending=t.assist.pending; renderAll(); hideEnd(); banners(); updateZoneBadge(); }
function switchRunner(which){ if(session.finished) return; saveTemp(); session.active=which; reset(); paintHeader(); loadTemp(); }

/* ================== R√®gles Tours ‚Üí Fl√®ches ================== */
function calcAllowedShots(){ const {tb,fb}=session.rules; const blocs=Math.floor(session.laps/tb); return blocs*fb; }
const allowedEl=qs('#allowed'), shotCountEl=qs('#shotCount'), remainEl=qs('#remain'), remainChip=qs('#remainChip');
function renderAllowances(){
  const allowed=calcAllowedShots(); const remain=Math.max(0,allowed-session.shots.length);
  allowedEl.textContent=allowed; shotCountEl.textContent=session.shots.length; remainEl.textContent=remain;
  if(remain>0) remainChip.classList.add('glow'); else remainChip.classList.remove('glow');
  qs('#lapPlus').disabled = (remain>0);
}

/* ================== Tours ================== */
qs('#lapPlus').onclick=()=>{ if(session.finished) return; const allowed=calcAllowedShots(); const pending=allowed-session.shots.length;
  if(pending>0){ showToast(`D'abord tirer ${pending} fl√®che${pending>1?'s':''}`); return; } session.laps++; renderAll(); };
qs('#lapMinus').onclick=()=>{ if(session.finished) return; session.laps=Math.max(0,session.laps-1); renderAll(); };
function renderLaps(){ lapsEl.textContent=session.laps; liveDistanceEl.textContent=Math.round((session.laps+(session.frac||0))*session.tourM); }

/* ================== Tir + Auto-aide Zone 2 ================== */
const shotsTable=qs('#shotsTable');
document.querySelectorAll('#scoreButtons [data-score]').forEach(btn=>{
  btn.onclick=()=>{
    if(session.finished) return;
    const allowed=calcAllowedShots();
    if(session.shots.length>=allowed){
      const need = session.rules.tb - (session.laps % session.rules.tb || session.rules.tb);
      showToast(`Pas assez de tours : +${need} tour${need>1?'s':''}`); return;
    }
    const score=+btn.getAttribute('data-score');
    const fb=session.rules.fb;
    const isNewVolley = (session.shots.length % fb === 0); // 1√®re fl√®che d'une vol√©e
    if(isNewVolley){
      // appliquer zone 2 si programm√©e pour cette vol√©e
      if(session.assist.nextVolley){
        if(session.assist.manual && !session.assist.pending){
          session.assist.pending = true; // on affiche la barre de confirmation
          banners(); // montrera confirmbar
        }else if(!session.assist.manual){
          session.assist.currentVolley = true; session.assist.nextVolley=false; banners(); updateZoneBadge();
        }
      }else{
        session.assist.currentVolley = false; updateZoneBadge(); banners();
      }
    }
    addShot(score); setAdviceSmart('shot');
    // Si fin de vol√©e, √©valuer pour la prochaine et repasser Zone 1
    if(session.shots.length % fb === 0){
      // fin de la vol√©e en cours -> Zone 1
      session.assist.currentVolley = false;
      banners(); updateZoneBadge();
      // √©value si la prochaine vol√©e doit √™tre en Zone 2
      maybeScheduleAssistForNextVolley();
    }
  };
});
function addShot(score){ session.shots.push({n:session.shots.length+1, score}); renderShots(); renderAllowances(); renderSummaryCounters(); }
function renderShots(){
  shotsTable.innerHTML=''; [...session.shots].slice().reverse().forEach(s=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${s.n}</td><td>${s.score}</td><td><button class="b-red btn-lg">Retirer</button></td>`;
    tr.querySelector('button').onclick=()=>{ if(session.finished) return;
      session.shots=session.shots.filter(x=>x.n!==s.n).map((x,i)=>({n:i+1,score:x.score}));
      renderShots(); renderAllowances(); renderSummaryCounters(); };
    shotsTable.append(tr);
  });
}
function maybeScheduleAssistForNextVolley(){
  const fb=session.rules.fb; if(fb<=0) return;
  const lastVolley = session.shots.slice(-fb);
  const zeros = lastVolley.filter(s=>s.score===0).length;
  const sum   = lastVolley.reduce((a,b)=>a+b.score,0);
  const A=session.assist;

  A.blocked = qs('#assist_blocked_live').checked || A.blocked;
  if(A.enabled && !A.blocked && (zeros>=A.thrZeros || sum<=A.thrSum)){
    if(A.manual){
      A.pending = true; // demander confirmation
      qs('#assistConfirm').classList.remove('hidden');
      qs('#assistBannerNext').classList.add('hidden');
    }else{
      A.nextVolley = true; A.pending=false;
      showToast('Aide activ√©e : avance sur la prochaine vol√©e.');
      banners();
    }
  }else{
    A.nextVolley = false; A.pending=false;
    banners();
  }
}

/* Confirmation manuelle Zone 2 */
qs('#assistYes').onclick = ()=>{
  session.assist.nextVolley = true;
  session.assist.pending = false;
  banners();
  showToast('Zone 2 appliqu√©e √† la prochaine vol√©e.');
};
qs('#assistNo').onclick = ()=>{
  session.assist.nextVolley = false;
  session.assist.pending = false;
  banners();
  showToast('Zone 2 ignor√©e.');
};

function banners(){
  const bNext=qs('#assistBannerNext'), bNow=qs('#assistBannerNow'), cBar=qs('#assistConfirm');
  // Bandeau "prochaine vol√©e"
  bNext.classList.toggle('hidden', !(session.assist.nextVolley && !session.assist.manual));
  // Bandeau "vol√©e en cours" ‚Äî toujours visible avec le bon libell√©
  const zoneNow = session.assist.currentVolley ? '2' : '1';
  bNow.textContent = 'Vol√©e en Zone ' + zoneNow;
  bNow.classList.toggle('ok', session.assist.currentVolley); // style diff√©rent si zone 2
  // Barre de confirmation si manuel
  cBar.classList.toggle('hidden', !session.assist.pending);
}
function updateZoneBadge(){
  zoneBadge.textContent = 'Zone actuelle : ' + (session.assist.currentVolley ? 'Zone 2' : 'Zone 1');
}

/* ================== Indice & compteurs ================== */
const c0El=qs('#c0'), c6El=qs('#c6'), c7El=qs('#c7'), c8El=qs('#c8'), c9El=qs('#c9'), c10El=qs('#c10'), indiceArcEl=qs('#indiceArc');
function scoreCounts(){ const c={0:0,6:0,7:0,8:0,9:0,10:0}; session.shots.forEach(s=>{ if(c.hasOwnProperty(s.score)) c[s.score]++; }); return c; }
function sumScores(){ return session.shots.reduce((a,b)=> a + ((b&&b.score)||0), 0); }
function computeIndiceArc(){ const T=session.shots.length; if(!T) return 0; const avg=sumScores()/T; return +(avg*10).toFixed(2); }
function renderSummaryCounters(){ const c=scoreCounts();
  c0El.textContent=c[0]; c6El.textContent=c[6]; c7El.textContent=c[7]; c8El.textContent=c[8]; c9El.textContent=c[9]; c10El.textContent=c[10];
  indiceArcEl.textContent=computeIndiceArc(); }

/* ================== Conseils ================== */
const adviceTxt=qs('#adviceTxt'); const ADVICE_COOLDOWN_EVENTS=3; const adviceHistory=[];
const ADICT={ breath:"Respire calmement.", breath5:"Ferme les yeux, 5 respirations.", anchor:"Tiens mieux ton arc.", routine:"Refais pareil.", tempo:"Prends ton temps.", hydrate:"Bois un peu.", focus:"Reste concentr√©." };
function pushAdviceTypeOnce(type, bag){ if(!type) return; if(adviceHistory.slice(-ADVICE_COOLDOWN_EVENTS).includes(type)) return; bag.push(type); }
function buildAdviceTypes(context){
  const types=[]; const T=session.shots.length; const indice=computeIndiceArc();
  if(context==='shot' && T>0){ const last=session.shots[T-1].score;
    if(last===0){ if(T===1) pushAdviceTypeOnce('breath5',types); else pushAdviceTypeOnce('breath',types); pushAdviceTypeOnce('anchor',types); }
    else if(last<=6){ pushAdviceTypeOnce('anchor',types); pushAdviceTypeOnce('tempo',types); }
    else if(last<=8){ pushAdviceTypeOnce('focus',types); }
    else { pushAdviceTypeOnce('routine',types); }
  }
  if(indice<40) pushAdviceTypeOnce('breath',types); else if(indice<70) pushAdviceTypeOnce('focus',types); else pushAdviceTypeOnce('routine',types);
  if(session.dureeMin<=5) pushAdviceTypeOnce('breath',types); else if(session.dureeMin>10) pushAdviceTypeOnce('tempo',types);
  if(context==='end'){ pushAdviceTypeOnce('hydrate',types); if(indice<70) pushAdviceTypeOnce('focus',types); else pushAdviceTypeOnce('routine',types); }
  if(types.length===0) pushAdviceTypeOnce('focus',types); return types;
}
function setAdvice(t){ adviceTxt.textContent = (t&&t.trim())? t : '‚Äî'; }
function setAdviceSmart(context){ const types=buildAdviceTypes(context); types.forEach(t=>adviceHistory.push(t)); while(adviceHistory.length>20) adviceHistory.shift(); const max=(context==='end')?3:2; setAdvice(types.slice(0,max).map(t=>ADICT[t]).join(' ')); }

/* ================== Fin de course ================== */
const endCard=qs('#endCard'), distanceOut=qs('#distanceOut'), toSummaryWrap=qs('#toSummaryWrap');
document.querySelectorAll('[data-frac]').forEach(b=> b.onclick=()=>{ if(session.finished) return; session.frac=+b.getAttribute('data-frac'); updateDistanceOut(); });
qs('#finishRunner').onclick=()=> finalizeRunner();
function showEnd(){ endCard.classList.remove('hidden'); updateDistanceOut(); if(navigator.vibrate) navigator.vibrate(120); }
function hideEnd(){ endCard.classList.add('hidden'); }
function updateDistanceOut(){ const meters=Math.round((session.laps+(session.frac||0))*session.tourM); distanceOut.textContent=`Distance : ${meters} m`; }
function finalizeRunner(){
  const R=session[session.active]; const meters=Math.round((session.laps+(session.frac||0))*session.tourM);
  const c=scoreCounts(); const indice=computeIndiceArc();
  session.results[session.active]={ prenom:R.prenom, nom:R.nom, classe:R.classe, sexe:R.sexe, distance:meters,
    nb0:c[0], nb6:c[6], nb7:c[7], nb8:c[8], nb9:c[9], nb10:c[10], indice_arc:indice };
  hideEnd();
  const other=session.active==='p1'?'p2':'p1';
  if(!session.results[other]){ setAdviceSmart('end'); showToast('Coureur termin√©. Passez au second.'); switchRunner(other); return; }
  session.finished=true; document.getElementById('pickP1').disabled=true; document.getElementById('pickP2').disabled=true;
  toSummaryWrap.classList.remove('hidden'); setAdviceSmart('end');
}

/* ================== R√©sum√© / QR / CSV ================== */
let summaryData=[]; let profMode=false;
function buildQrData(rows){ return rows.map(d=>({nom:d.nom, prenom:d.prenom, classe:d.classe, sexe:d.sexe,
  distance:d.distance, nb0:d.nb0, nb6:d.nb6, nb7:d.nb7, nb8:d.nb8, nb9:d.nb9, nb10:d.nb10, indice_arc:d.indice_arc })); }
function buildQR(payload){ const box=qs('#qr'); box.innerHTML=''; try{ if(window.QRCode){ new QRCode(box,{ text:payload, width:256, height:256, correctLevel:QRCode.CorrectLevel.M }); } }catch(e){ console.warn('QR non g√©n√©r√©',e); } }
function toCSV(data){ const H=['nom','prenom','classe','sexe','distance','nb0','nb6','nb7','nb8','nb9','nb10','indice_arc'];
  const esc=v=>{ const s=(v==null?'':String(v)); return /[;\"\n]/.test(s)? `"${s.replace(/\"/g,'""')}"` : s; };
  return [H.join(';'), ...data.map(d=>H.map(h=>esc(d[h])).join(';'))].join('\n'); }
function renderSummary(){
  const rows = summaryData.map((d,i)=>`
    <tr data-index="${i}">
      <td data-field="nom" ${profMode?'contenteditable':''}>${d.nom}</td>
      <td data-field="prenom" ${profMode?'contenteditable':''}>${d.prenom}</td>
      <td data-field="classe" ${profMode?'contenteditable':''}>${d.classe}</td>
      <td data-field="sexe" ${profMode?'contenteditable':''}>${d.sexe}</td>
      <td data-field="distance" ${profMode?'contenteditable':''}>${d.distance}</td>
      <td data-field="nb0" ${profMode?'contenteditable':''}>${d.nb0}</td>
      <td data-field="nb6" ${profMode?'contenteditable':''}>${d.nb6}</td>
      <td data-field="nb7" ${profMode?'contenteditable':''}>${d.nb7}</td>
      <td data-field="nb8" ${profMode?'contenteditable':''}>${d.nb8}</td>
      <td data-field="nb9" ${profMode?'contenteditable':''}>${d.nb9}</td>
      <td data-field="nb10" ${profMode?'contenteditable':''}>${d.nb10}</td>
      <td>${d.indice_arc}</td>
    </tr>`).join('');
  qs('#resume').innerHTML = `
    <details>
      <summary>Tableau r√©capitulatif</summary>
      <div style="overflow:auto; margin-top:8px">
        <table>
          <thead><tr>
            <th>Nom</th><th>Pr√©nom</th><th>Classe</th><th>Sexe</th>
            <th>Distance (m)</th><th>Nb 0</th><th>Nb 6</th><th>Nb 7</th><th>Nb 8</th><th>Nb 9</th><th>Nb 10</th>
            <th>Indice (%)</th>
          </tr></thead>
          <tbody id="resumeBody">${rows}</tbody>
        </table>
      </div>
    </details>`;
  const payloadQR = JSON.stringify(buildQrData(summaryData)); buildQR(payloadQR);
  const exportBtn=qs('#exportCsv');
  exportBtn.onclick=()=>{ const csv=toCSV(summaryData); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a');
    a.href=url; a.download=`ArcAthlon_${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); };
  const profHint=qs('#profHint'), act=qs('#activateProf'), deact=qs('#deactivateProf'), apply=qs('#applyEdits');
  act.disabled=profMode; deact.disabled=!profMode; apply.disabled=!profMode;
  profHint.textContent = profMode ? 'Mode Prof : corrigez puis ‚ÄúMettre √† jour‚Äù.' : 'Entrer le code Prof pour modifier.';
}
function parseEditsFromTable(){
  const tbody=document.getElementById('resumeBody'); const rows=[...tbody.querySelectorAll('tr')];
  return rows.map(tr=>{
    const txt=field=>(tr.querySelector(`[data-field="${field}"]`)?.textContent||'').trim();
    const int=(field,def=0)=>{ const v=parseInt((txt(field)||'').replace(',','.'),10); return Number.isFinite(v)?Math.max(0,v):def; };
    const nb0=int('nb0'),nb6=int('nb6'),nb7=int('nb7'),nb8=int('nb8'),nb9=int('nb9'),nb10=int('nb10');
    const total=nb0+nb6+nb7+nb8+nb9+nb10; const pts=nb6*6+nb7*7+nb8*8+nb9*9+nb10*10;
    const indice= total>0 ? +(((pts/total)/10*100).toFixed(2)) : 0;
    const sx=(txt('sexe')||'').toUpperCase(); const sexe = (sx==='M'||sx==='F')?sx:'F';
    return { nom:txt('nom'), prenom:txt('prenom'), classe:txt('classe'),
      sexe, distance:int('distance'), nb0,nb6,nb7,nb8,nb9,nb10, indice_arc:indice };
  });
}
qs('#activateProf').onclick=()=>{ const code=(qs('#profCode').value||'').trim(); if(code===PROF_CODE){ profMode=true; renderSummary(); } else { showToast('Code incorrect.'); } };
qs('#deactivateProf').onclick=()=>{ profMode=false; renderSummary(); };
qs('#applyEdits').onclick=()=>{ summaryData=parseEditsFromTable(); renderSummary(); showToast('Bilan mis √† jour.'); };
qs('#goSummary').onclick=()=>{ const out=[]; if(session.results.p1) out.push({...session.results.p1}); if(session.results.p2) out.push({...session.results.p2});
  summaryData=out; show('summary'); profMode=false; renderSummary(); };
qs('#backToCourse').onclick=()=> show('course');

/* ================== Rendu global & init ================== */
function renderAll(){ renderLaps(); renderAllowances(); renderShots(); renderSummaryCounters(); }
function hideEnd(){ qs('#endCard').classList.add('hidden'); }
function setAdvice(t){ qs('#adviceTxt').textContent = (t&&t.trim())? t : '‚Äî'; }
function resetRunnerState(){ session.laps=0; session.shots=[]; session.frac=0; Object.assign(session.assist,{nextVolley:false,currentVolley:false,pending:false}); renderAll(); hideEnd(); setAdvice(''); banners(); updateZoneBadge(); }

validate(); setAdvice('');
try{ console.assert(!!V.cover && !!V.setup && !!V.course && !!V.summary, 'vues ok'); }catch(_){}
</script>
</body>
</html>
