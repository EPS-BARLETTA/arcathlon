<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ArcAthlon-V2</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f6f8fb; --card:#fff; --ink:#0b1220; --muted:#6b7280; --primary:#0a58ff;
    --green:#22c55e; --amber:#f59e0b; --red:#ef4444; --slate:#334155;
    --ring:0 10px 40px rgba(2,6,23,.08); --radius:18px;
    --adviceRing:#c7d2fe; --adviceBg:#eef2ff; --adviceBadge:#4338ca;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; background:var(--bg); color:var(--ink); font:17px/1.35 Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; display:flex; flex-direction:column;}
  .wrap{max-width:980px; margin:0 auto; padding:16px; width:100%}
  h1,h2,h3{margin:0 0 10px; text-align:center}
  h1{font-size:clamp(24px,4vw,36px); font-weight:800}
  h2{font-size:clamp(20px,3vw,28px); font-weight:800}
  h3{font-size:clamp(18px,2.6vw,22px); font-weight:800}
  p{margin:6px 0; color:var(--muted)}
  .card{background:var(--card); border-radius:var(--radius); box-shadow:var(--ring); padding:14px}
  .hidden{display:none!important}
  [hidden]{display:none!important}

  .btns{display:flex; gap:12px; flex-wrap:wrap; justify-content:center; align-items:center}
  button{border:0; border-radius:16px; font-weight:800; cursor:pointer}
  .btn-xl{padding:18px 20px; font-size:20px}
  .btn-lg{padding:16px 18px; font-size:18px}
  .btn-xxl{padding:22px 26px; font-size:28px}
  .b-primary{background:var(--primary); color:#fff}
  .b-green{background:var(--green); color:#fff}
  .b-amber{background:var(--amber); color:#111}
  .b-red{background:var(--red); color:#fff}
  .b-slate{background:var(--slate); color:#fff}
  .b-ghost{background:#eef2f7; color:#0b1220}

  label{display:block; font-weight:800; margin:8px 0 6px}
  input,select{width:100%; padding:14px 16px; border:2px solid #e5e7eb; border-radius:14px; background:#fff; font:inherit}
  input[type=number]{appearance:textfield}

  .grid{display:grid; gap:12px}
  .g2{grid-template-columns:1fr 1fr}
  @media (max-width:720px){ .g2{grid-template-columns:1fr} }

  .hero{display:flex; align-items:center; justify-content:center; min-height:50vh; text-align:center}
  .chrono{display:flex; align-items:center; justify-content:center; gap:12px; flex-wrap:wrap}
  .time{font-size:clamp(44px,9vw,78px); font-weight:900; letter-spacing:1px}
  .pill{display:inline-block; padding:6px 12px; border-radius:999px; background:#eef2f7; font-weight:800}

  .bigNum{font-size:48px; font-weight:900; text-align:center; margin-top:6px}
  .kpi{display:flex; gap:10px; justify-content:center; flex-wrap:wrap}
  .kchip{padding:8px 12px; border-radius:12px; font-weight:800}
  .kchip.allowed{background:#dbeafe; color:#0b1220}
  .kchip.shot{background:#ede9fe; color:#111827}
  .kchip.remain{background:#dcfce7; color:#065f46}
  .glow{animation:pulse 1s infinite alternate}
  @keyframes pulse{from{box-shadow:0 0 0 rgba(34,197,94,0)} to{box-shadow:0 0 18px rgba(34,197,94,.55)}}

  .shot-grid{display:grid; grid-template-columns:repeat(6,1fr); gap:10px}
  .shot-grid button{padding:16px 0; font-size:22px; border-radius:14px; font-weight:900}

  .advice{margin-top:10px; border:2px solid var(--adviceRing); background:var(--adviceBg); border-radius:16px; padding:12px 14px; text-align:center}
  .ad-badge{display:inline-block; padding:4px 10px; border-radius:999px; font-weight:800; color:#fff; background:var(--adviceBadge); font-size:14px}
  .ad-text{margin-top:6px; font-size:18px; color:#0b1220; font-weight:800}

  details{background:#f8fafc; border:1px dashed #dbe1ea; border-radius:12px; padding:8px 10px}
  details > summary{cursor:pointer; font-weight:800; margin:6px 0}
  table{width:100%; border-collapse:collapse}
  th,td{padding:10px; border-bottom:1px solid #e5e7eb; text-align:center}

  .toast{ position:fixed; left:50%; bottom:84px; transform:translateX(-50%); background:#111827; color:#fff; padding:10px 14px; border-radius:10px;
    box-shadow:0 10px 30px rgba(2,6,23,.35); font-weight:800; z-index:90; opacity:0; pointer-events:none; transition:opacity .2s, transform .2s; max-width:92vw; text-align:center}
  .toast.show{opacity:1; transform:translateX(-50%) translateY(-6px)}

  .banner{background:#fff7ed; border:2px dashed #f59e0b; color:#7c2d12; border-radius:12px; padding:8px 10px; text-align:center; font-weight:800}
  .banner.zone2{background:#ecfeff; border-color:#06b6d4; color:#155e75}

  .runnerBadge{
    display:flex; align-items:center; justify-content:center;
    margin:8px auto 0; min-height:56px; padding:10px 18px; max-width:420px;
    background:var(--green); color:#fff; border-radius:16px; font-weight:900; font-size:22px; text-transform:uppercase;
  }

  /* Modal g√©n√©rique */
  .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:80;
    background:linear-gradient(180deg,rgba(2,6,23,.55),rgba(2,6,23,.35));}
  .modal.show{display:flex;}
  .modal-card{background:#fff; border-radius:20px; max-width:900px; width:92%; overflow:hidden; box-shadow:0 12px 48px rgba(2,6,23,.25)}
  .modal-head{display:flex; align-items:center; gap:12px; padding:16px 18px; color:#fff; font-weight:800}
  .modal-head.help{background:linear-gradient(90deg,#0a58ff,#7c3aed)}
  .modal-head.safe{background:linear-gradient(90deg,#22c55e,#0ea5e9)}
  .modal-head.indice{background:linear-gradient(90deg,#111827,#0a58ff)}
  .modal-head.settings{background:linear-gradient(90deg,#0a58ff,#22c55e)}
  .modal-body{padding:18px}
  .help-list{margin:8px 0 12px; line-height:1.55}
  .help-list li{margin:6px 0}

  /* Modal fin de temps (bandeau central) */
  .modal-end .modal-card{max-width:680px}
  .end-actions{display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:8px}

  footer{margin-top:auto; padding:10px; text-align:center; color:var(--muted)}

  /* petite aide visuelle pour inputs d'√©dition en mode prof */
  .edit-input{width:100%; padding:8px 10px; border:2px solid #dbe1ea; border-radius:10px; font:inherit; text-align:center}
</style>
</head>
<body>
  <div class="wrap">
    <!-- ACCUEIL -->
    <section id="view-cover" class="card hero">
      <div style="width:100%; max-width:640px; margin:0 auto;">
        <h1>ArcAthlon-V2</h1>
        <p class="muted">EPS ‚Ä¢ ScanProf ready</p>

        <div class="btns" style="margin-top:14px">
          <button id="btnStartApp" class="b-primary btn-xxl">‚ñ∂Ô∏è D√©marrer</button>
        </div>
        <div class="btns" style="margin-top:10px">
          <button id="btnHelp" class="b-slate btn-lg">‚ÑπÔ∏è Aide</button>
          <button id="btnSafety" class="b-ghost btn-lg">üõü Fiche s√©curit√©</button>
          <button id="btnIndice" class="b-ghost btn-lg">üéØ Indice arc</button>
          <button id="btnSettings" class="b-ghost btn-lg">‚öôÔ∏è Param√®tres</button>
        </div>
      </div>
    </section>

    <!-- SAISIE -->
    <section id="view-setup" class="card hidden" hidden>
      <h2>Param√®tres & coureurs</h2>
      <div class="grid g2">
        <div>
          <h3>Coureur 1</h3>
          <label>Pr√©nom</label><input id="p1_prenom" autocomplete="off">
          <label>Nom</label><input id="p1_nom" autocomplete="off">
          <label>Classe</label><input id="p1_classe" autocomplete="off">
          <label>Sexe</label>
          <select id="p1_sexe"><option value="">‚Äî</option><option>F</option><option>M</option></select>
        </div>
        <div>
          <h3>Coureur 2</h3>
          <label>Pr√©nom</label><input id="p2_prenom" autocomplete="off">
          <label>Nom</label><input id="p2_nom" autocomplete="off">
          <label>Classe</label><input id="p2_classe" autocomplete="off">
          <label>Sexe</label>
          <select id="p2_sexe"><option value="">‚Äî</option><option>F</option><option>M</option></select>
        </div>
      </div>

      <div class="grid g2" style="margin-top:8px">
        <div>
          <label>Dur√©e (minutes)</label>
          <input id="duree_min" type="number" min="1" step="1" placeholder="ex. 8">
        </div>
        <div>
          <label>Longueur d‚Äôun tour (m)</label>
          <input id="tour_m" type="number" min="10" step="1" placeholder="ex. 200">
        </div>
      </div>

      <div class="grid g2" style="margin-top:8px">
        <div>
          <label>Tours par bloc</label>
          <input id="tours_bloc" type="number" min="1" step="1" value="3">
        </div>
        <div>
          <label>Fl√®ches par bloc</label>
          <input id="fleches_bloc" type="number" min="1" step="1" value="3">
        </div>
      </div>

      <div class="btns" style="margin-top:8px">
        <button class="b-slate btn-lg" id="preset33">3 tours ‚Üí 3 fl√®ches</button>
        <button class="b-slate btn-lg" id="preset11">1 tour ‚Üí 1 fl√®che</button>
        <button class="b-slate btn-lg" id="preset13">1 tour ‚Üí 3 fl√®ches</button>
        <button id="openSettingsFromSetup" class="b-ghost btn-lg">‚öôÔ∏è Param√®tres</button>
      </div>

      <div class="btns" style="margin-top:10px">
        <button id="goCourse" class="b-primary btn-xl" disabled>Acc√©der √† la course</button>
        <button id="goHome" class="b-slate btn-lg">üè† Accueil</button>
      </div>
    </section>

    <!-- COURSE -->
    <section id="view-course" class="hidden" hidden>
      <div class="card">
        <div class="btns" style="justify-content:space-between; gap:8px">
          <button id="backSetup" class="b-slate btn-lg">‚¨Ö Saisie</button>
          <span class="pill" id="metaRunner">‚Äî</span>
        </div>
        <h2 id="runnerTitle">‚Äî</h2>

        <!-- Pr√©nom unique en gros bloc vert -->
        <div id="runnerBadge" class="runnerBadge">‚Äî</div>

        <div class="btns" style="margin:6px 0">
          <span class="pill" id="zoneBadge">Zone 1</span>
        </div>

        <!-- Chrono -->
        <div class="chrono card" style="margin-top:6px">
          <div class="time" id="clock">00:00.0</div>
          <div class="btns">
            <button id="btnStartChrono" class="b-primary btn-xxl">‚ñ∂Ô∏è D√©marrer</button>
            <button id="btnPause" class="b-amber btn-lg" disabled>‚è∏Ô∏è</button>
            <button id="btnReset" class="b-red btn-lg" disabled>‚Ü∫</button>
          </div>
        </div>
        <p class="muted" style="text-align:center">Dur√©e cible : <b id="target"></b> min</p>

        <!-- Bandeau simple Zone 2 (3 fl√®ches) -->
        <div id="zone2Banner" class="banner zone2 hidden" hidden>3 fl√®ches en Zone 2</div>
      </div>

      <div class="grid g2" style="margin-top:10px">
        <!-- Tours -->
        <div class="card">
          <h3>Tours</h3>
          <div class="bigNum" id="laps">0</div>
          <div class="kpi">
            <span class="kchip">1 tour = <b id="lapMeters">‚Äî</b> m</span>
            <span class="kchip">Distance : <b id="liveDistance">0</b> m</span>
          </div>
          <div class="btns" style="margin-top:8px">
            <button id="lapPlus" class="b-green btn-xl">+1 tour</button>
            <button id="lapMinus" class="b-slate btn-lg">‚àí1</button>
          </div>
        </div>

        <!-- Tir -->
        <div class="card">
          <h3>Tir (0,6,7,8,9,10)</h3>
          <div class="kpi" style="margin-bottom:6px">
            <span class="kchip allowed">Autoris√©es : <b id="allowed">0</b></span>
            <span class="kchip shot">Tir√©es : <b id="shotCount">0</b></span>
            <span class="kchip remain" id="remainChip">Restantes : <b id="remain">0</b></span>
            <span class="kchip">Indice : <b id="indiceArc">0</b>%</span>
          </div>

          <div class="advice" id="adviceBox">
            <span class="ad-badge">Conseil</span>
            <div class="ad-text" id="adviceTxt">‚Äî</div>
          </div>

          <div class="shot-grid" id="scoreButtons" style="margin-top:8px">
            <button class="b-slate" data-score="0">0</button>
            <button class="b-slate" data-score="6">6</button>
            <button class="b-slate" data-score="7">7</button>
            <button class="b-slate" data-score="8">8</button>
            <button class="b-slate" data-score="9">9</button>
            <button class="b-slate" data-score="10">10</button>
          </div>

          <details style="margin-top:10px">
            <summary>Voir d√©tails & compteurs</summary>
            <div class="kpi" style="margin-top:6px">
              <span class="kchip">Nb 10 : <b id="c10">0</b></span>
              <span class="kchip">Nb 9 : <b id="c9">0</b></span>
              <span class="kchip">Nb 8 : <b id="c8">0</b></span>
              <span class="kchip">Nb 7 : <b id="c7">0</b></span>
              <span class="kchip">Nb 6 : <b id="c6">0</b></span>
              <span class="kchip">Nb 0 : <b id="c0">0</b></span>
            </div>
            <div style="overflow:auto; margin-top:6px">
              <table>
                <thead><tr><th>#</th><th>Score</th><th>Action</th></tr></thead>
                <tbody id="shotsTable"></tbody>
              </table>
            </div>
          </details>
        </div>
      </div>
    </section>

    <!-- BILAN / QR -->
    <section id="view-summary" class="card hidden" style="text-align:center" hidden>
      <h2>Bilan ‚Äî QR compatible ScanProf</h2>
      <div id="qr" class="card" style="display:inline-block"></div>

      <div class="card" style="margin-top:8px">
        <div class="btns" style="flex-wrap:wrap">
          <button class="b-primary btn-lg" id="exportCsv">‚¨áÔ∏è Export CSV</button>
          <button class="b-ghost btn-lg" id="btnProfMode">üîí Mode prof</button>
          <button class="b-green btn-lg hidden" id="btnSaveEdits">üíæ Enregistrer</button>
          <button class="b-red btn-lg hidden" id="btnCancelEdits">‚ùå Annuler</button>
        </div>
        <p class="muted" id="summaryNote" style="margin-top:6px">Le tableau est non-modifiable (Param√®tres simplifi√©s).</p>
      </div>

      <div id="resume" style="margin-top:8px"></div>

      <div class="btns" style="margin-top:10px">
        <button class="b-slate btn-lg" id="backToCourse">‚¨Ö Retour course</button>
        <button class="b-green btn-lg" id="backHome2">üè† Accueil</button>
      </div>
    </section>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <footer>ArcAthlon - √âquipe EPS Lyc√©e Vauban - LUXEMBOURG - JB</footer>

  <!-- Modales info -->
  <div class="modal" id="modalHelp" hidden>
    <div class="modal-card">
      <div class="modal-head help"><span>‚ÑπÔ∏è</span><span>Mode d‚Äôemploi ‚Äî ArcAthlon-V2</span></div>
      <div class="modal-body">
        <ol class="help-list">
          <li>Saisir pour chaque √©l√®ve : <strong>Pr√©nom</strong>, <strong>Nom</strong>, <strong>Classe</strong>, <strong>Sexe</strong>.</li>
          <li>R√©gler la dur√©e, la longueur d‚Äôun tour, et la r√®gle <strong>Tours ‚Üí Fl√®ches</strong>.</li>
          <li>Avant de d√©marrer, ouvrir <strong>Param√®tres</strong> pour :
            <ul>
              <li><b>Activer commentaires</b> (ON par d√©faut) : affiche les conseils contextuels.</li>
              <li><b>Activer Zone 2</b> (OFF par d√©faut) : si coch√©, la vol√©e <em>suivante</em> passe en <b>Zone 2 (3 fl√®ches)</b> si la vol√©e pr√©c√©dente :
                <ul>
                  <li>a au moins <b id="aid_thrZeros">3</b> z√©ros <em>ou</em></li>
                  <li>a une <b>Somme</b> ‚â§ <b id="aid_thrSum">20</b>.</li>
                </ul>
                Les seuils sont modifiables (ex. 2 z√©ros, 25 points). Apr√®s 3 fl√®ches, retour visuel en Zone 1.</li>
            </ul>
          </li>
          <li>En course : <strong>Start/Pause</strong> le chrono ; <strong>+1 / ‚àí1</strong> pour les tours ; saisir les scores (0,6,7,8,9,10).</li>
          <li>Fin du temps : un bandeau <strong>central</strong> permet d‚Äôajuster la <strong>fraction de tour</strong> et de passer √† <b>Course 2</b>, puis au <b>Bilan</b>.</li>
        </ol>
        <div class="btns"><button class="b-slate btn-lg" data-close>Fermer</button></div>
      </div>
    </div>
  </div>

  <div class="modal" id="modalSafety" hidden>
    <div class="modal-card">
      <div class="modal-head safe"><span>üõü</span><span>Fiche s√©curit√©</span></div>
      <div class="modal-body">
        <h4>Avant l‚Äôactivit√©</h4>
        <ul class="help-list">
          <li>Zone de course d√©gag√©e ; surface adh√©rente ; pas d‚Äôobstacles.</li>
          <li>Pas de tir mat√©rialis√© + zone d‚Äôattente.</li>
          <li>Contr√¥ler arcs/fl√®ches (branches, corde, empennage, pointes).</li>
        </ul>
        <h4>Au pas de tir</h4>
        <ul class="help-list">
          <li>Arc vers les cibles ; on tire <strong>uniquement</strong> sur signal.</li>
          <li>Personne devant la ligne ; on pose l‚Äôarc √† l‚Äôarr√™t.</li>
        </ul>
        <h4>R√©cup√©ration</h4>
        <ul class="help-list">
          <li>Sur signal ; on marche, pas de course devant la cible.</li>
          <li>Retirer la fl√®che dans l‚Äôaxe, main sur la cible.</li>
        </ul>
        <div class="btns"><button class="b-slate btn-lg" data-close>Fermer</button></div>
      </div>
    </div>
  </div>

  <div class="modal" id="modalIndice" hidden>
    <div class="modal-card">
      <div class="modal-head indice"><span>üéØ</span><span>Indice arc ‚Äî explication</span></div>
      <div class="modal-body">
        <p><strong>But :</strong> mesurer la pr√©cision de 0 √† 100%.</p>
        <p><strong>Scores par fl√®che :</strong> 0, 6, 7, 8, 9, 10.</p>
        <p><strong>Calcul :</strong> moyenne des points sur 10, puis sur 100.</p>
        <ul class="help-list">
          <li>Total fl√®ches T = nb0 + nb6 + nb7 + nb8 + nb9 + nb10</li>
          <li>Total points P = 6√ónb6 + 7√ónb7 + 8√ónb8 + 9√ónb9 + 10√ónb10</li>
          <li><b>Indice (%) = (P / T) √∑ 10 √ó 100</b></li>
        </ul>
        <div class="btns"><button class="b-slate btn-lg" data-close>Fermer</button></div>
      </div>
    </div>
  </div>

  <!-- Param√®tres (r√©glables avant course) -->
  <div class="modal" id="modalSettings" hidden>
    <div class="modal-card">
      <div class="modal-head settings"><span>‚öôÔ∏è</span><span>Param√®tres</span></div>
      <div class="modal-body">
        <div class="grid g2">
          <div>
            <label><input type="checkbox" id="set_comments" checked> Activer commentaires</label>
            <p class="muted">Affiche les conseils contextuels pendant la course.</p>
          </div>
          <div>
            <label><input type="checkbox" id="set_zone2"> Activer Zone 2</label>
            <p class="muted">Si coch√©, la vol√©e <em>suivante</em> passe en Zone 2 (3 fl√®ches) quand la vol√©e pr√©c√©dente est faible.</p>
          </div>
        </div>

        <div class="grid g2" style="margin-top:6px">
          <div>
            <label>Seuil de z√©ros / vol√©e (‚â•)</label>
            <input id="set_thrZeros" type="number" min="1" step="1" value="3">
          </div>
          <div>
            <label>Seuil points / vol√©e (‚â§)</label>
            <input id="set_thrSum" type="number" min="0" step="1" value="20">
          </div>
        </div>

        <p class="muted" style="margin-top:6px">Ces r√©glages s‚Äôappliquent √† la prochaine session (Course 1), puis restent verrouill√©s durant la course.</p>
        <div class="btns" style="margin-top:10px">
          <button id="settingsSave" class="b-green btn-lg">üíæ Enregistrer</button>
          <button class="b-slate btn-lg" data-close>Fermer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bandeau central fin de temps -->
  <div class="modal modal-end" id="modalEnd" hidden>
    <div class="modal-card">
      <div class="modal-head settings"><span>‚è±Ô∏è</span><span>Temps √©coul√©</span></div>
      <div class="modal-body" style="text-align:center">
        <h3>Fraction de tour</h3>
        <div class="end-actions">
          <button class="b-slate btn-lg" data-frac="0">+ 0</button>
          <button class="b-slate btn-lg" data-frac="0.25">+ 1/4</button>
          <button class="b-slate btn-lg" data-frac="0.5">+ 1/2</button>
          <button class="b-slate btn-lg" data-frac="0.75">+ 3/4</button>
        </div>
        <p class="muted" id="distanceOut" style="margin-top:6px">Distance : ‚Äî m</p>
        <div class="btns" style="margin-top:8px">
          <button class="b-green btn-xl" id="endAction">‚û°Ô∏è Continuer</button>
        </div>
      </div>
    </div>
  </div>

  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"
          onerror="window.QRCode=undefined"></script>

<script>
'use strict';

/* ============ Helpers / vues / modales ============ */
const qs = sel => document.querySelector(sel);
const V = { cover: qs('#view-cover'), setup: qs('#view-setup'), course: qs('#view-course'), summary: qs('#view-summary') };
function show(name){ Object.values(V).forEach(v=>{ v.classList.add('hidden'); v.setAttribute('hidden',''); });
  const t=V[name]; if(t){ t.classList.remove('hidden'); t.removeAttribute('hidden'); } closeModals(); window.scrollTo(0,0); }
function openModal(id){ const m=qs('#'+id); if(!m) return; m.classList.add('show'); m.removeAttribute('hidden'); }
function closeModals(){ document.querySelectorAll('.modal').forEach(m=>{ m.classList.remove('show'); m.setAttribute('hidden',''); }); }
function showToast(msg, ms=1600){ const t=qs('#toast'); t.textContent=msg; t.classList.add('show'); clearTimeout(showToast.t); showToast.t=setTimeout(()=>t.classList.remove('show'),ms); }
document.addEventListener('click', (e)=>{ if(e.target.matches('[data-close]')) closeModals(); });
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModals(); });

/* ============ Boutons info ============ */
qs('#btnHelp').onclick   = ()=> openModal('modalHelp');
qs('#btnSafety').onclick = ()=> openModal('modalSafety');
qs('#btnIndice').onclick = ()=> openModal('modalIndice');
qs('#btnSettings').onclick = ()=>{ if(raceRunning) return showToast('Param√®tres verrouill√©s pendant la course.'); openModal('modalSettings'); };
qs('#openSettingsFromSetup').onclick = ()=> openModal('modalSettings');

/* ============ Navigation ============ */
qs('#btnStartApp').onclick = ()=> show('setup');
qs('#goHome').onclick      = ()=> show('cover');
qs('#backSetup').onclick   = ()=> show('setup');
qs('#backHome2').onclick   = ()=> show('cover');

/* ============ Validation saisie ============ */
function clean(s){ return (s||'').replace(/\s+/g,' ').trim(); }
function val(id){ return clean(document.getElementById(id).value); }
function okNum(v,min){ const n=+v; return Number.isFinite(n) && n>=min; }
function mark(el, good){ el.style.borderColor = good ? '#e5e7eb' : '#ef4444'; }
function validate(){
  const req = ['p1_prenom','p1_nom','p1_classe','p1_sexe','p2_prenom','p2_nom','p2_classe','p2_sexe'];
  let ok = true;
  req.forEach(id=>{ const el=document.getElementById(id); const good=val(id).length>0; mark(el,good); ok=ok&&good; });
  ['duree_min','tour_m','tours_bloc','fleches_bloc'].forEach(id=>{
    const good = okNum(val(id), id==='tour_m'?10:1);
    mark(document.getElementById(id), good); ok = ok && good;
  });
  qs('#goCourse').disabled = !ok; return ok;
}
['p1_prenom','p1_nom','p1_classe','p1_sexe','p2_prenom','p2_nom','p2_classe','p2_sexe','duree_min','tour_m','tours_bloc','fleches_bloc']
.forEach(id=>{ const el=document.getElementById(id); el.addEventListener('input',validate); el.addEventListener('change',validate); });

/* Presets tours‚Üífl√®ches */
qs('#preset33').onclick = ()=>{ document.getElementById('tours_bloc').value=3; document.getElementById('fleches_bloc').value=3; validate(); };
qs('#preset11').onclick = ()=>{ document.getElementById('tours_bloc').value=1; document.getElementById('fleches_bloc').value=1; validate(); };
qs('#preset13').onclick = ()=>{ document.getElementById('tours_bloc').value=1; document.getElementById('fleches_bloc').value=3; validate(); };

/* ============ Param√®tres (session) ============ */
const settings = {
  comments: true,       // Activer commentaires (ON par d√©faut)
  zone2: false,         // Activer Zone 2 (OFF par d√©faut)
  thrZeros: 3,
  thrSum: 20
};
function applySettingsFromModal(){
  settings.comments = qs('#set_comments').checked;
  settings.zone2    = qs('#set_zone2').checked;
  settings.thrZeros = Math.max(1, +qs('#set_thrZeros').value || 3);
  settings.thrSum   = Math.max(0, +qs('#set_thrSum').value || 20);
  // M√†J texte aide
  qs('#aid_thrZeros').textContent = settings.thrZeros;
  qs('#aid_thrSum').textContent = settings.thrSum;
}
qs('#settingsSave').onclick = ()=>{ if(raceRunning){ showToast('Param√®tres verrouill√©s pendant la course.'); return; } applySettingsFromModal(); showToast('Param√®tres enregistr√©s.'); };

/* ============ Session & √©tats course ============ */
const session={
  p1:null, p2:null, tourM:0, dureeMin:0, rules:{tb:3,fb:3},
  active:'p1', laps:0, frac:0, shots:[], results:{p1:null,p2:null},
  adviceEnabled:true, assistEnabled:false, thrZeros:3, thrSum:20
};
let raceRunning=false, timeOver=false, running=false, timer=null, t0=0, elapsed=0;
let phase='runner1';                  // 'runner1' -> 'runner2' -> 'done'
let zone2ShotsRemaining=0;            // 3 fl√®ches √† consommer si Z2 d√©clench√©e

/* ============ Entr√©e en course ============ */
qs('#goCourse').onclick=()=>{
  if(!validate()){ showToast('Compl√©tez tous les champs (dont Sexe).'); return; }
  function sex(id){ const s=(val(id)||'').toUpperCase(); return s==='M'?'M':'F'; }
  session.p1={ prenom:val('p1_prenom'), nom:val('p1_nom'), classe:val('p1_classe'), sexe:sex('p1_sexe') };
  session.p2={ prenom:val('p2_prenom'), nom:val('p2_nom'), classe:val('p2_classe'), sexe:sex('p2_sexe') };
  session.dureeMin=+val('duree_min'); session.tourM=+val('tour_m');
  session.rules.tb=+document.getElementById('tours_bloc').value;
  session.rules.fb=+document.getElementById('fleches_bloc').value;

  // Verrouiller la config dans la session
  applySettingsFromModal();
  Object.assign(session, {
    adviceEnabled: settings.comments,
    assistEnabled: settings.zone2,
    thrZeros: settings.thrZeros,
    thrSum: settings.thrSum
  });

  phase='runner1'; session.active='p1';
  resetAdviceHistory(); zone2ShotsRemaining=0;
  timeOver=false; raceRunning=false; running=false; elapsed=0;

  resetRunnerState(true);
  paintHeader(); paintRunnerBadge();
  if(session.adviceEnabled) setAdvice("Respire calmement. Reste concentr√©."); else hideAdviceBox();
  show('course');
};

/* ============ Chrono ============ */
const clockEl=qs('#clock'), targetEl=qs('#target');
qs('#btnStartChrono').onclick=start; qs('#btnPause').onclick=pause; qs('#btnReset').onclick=reset;
function start(){
  if(running) return;
  running=true; raceRunning=true;
  t0 = Date.now() - elapsed;
  timer = setInterval(tick,100);
  qs('#btnStartChrono').disabled=true;
  qs('#btnPause').disabled=false;
  qs('#btnReset').disabled=false;
  qs('#backSetup').disabled=true; // pas de retour saisie pendant la course
}
function pause(){ if(!running) return; running=false; clearInterval(timer); qs('#btnStartChrono').disabled=false; qs('#btnPause').disabled=true; }
function reset(){
  pause();
  elapsed=0; clockEl.textContent='00:00.0'; qs('#btnReset').disabled=true;
  if(timeOver) return; // si temps fini, on ne rouvre pas
  session.laps=0; session.shots=[]; session.frac=0;
  zone2ShotsRemaining=0; renderAll(); closeModalEnd(); resetAdviceHistory();
  if(session.adviceEnabled) setAdvice("Respire calmement. Reste concentr√©."); else hideAdviceBox();
  updateZoneVisuals();
}
function tick(){
  elapsed=Date.now()-t0;
  const cs=Math.floor(elapsed/100); const m=Math.floor(cs/600), s=Math.floor((cs%600)/10), d=cs%10;
  clockEl.textContent=`${m<10?'0':''}${m}:${s<10?'0':''}${s}.${d}`;
  if(m>=session.dureeMin){
    pause();
    timeOver=true;
    disableRaceInputs(true);
    openModalEnd();
    if(session.adviceEnabled) setAdviceSmart('end');
  }
}

/* ============ UI header ============ */
const runnerTitle=qs('#runnerTitle'), metaRunner=qs('#metaRunner'), lapMetersEl=qs('#lapMeters'),
      lapsEl=qs('#laps'), liveDistanceEl=qs('#liveDistance'), zoneBadge=qs('#zoneBadge'), runnerBadge=qs('#runnerBadge');
function paintHeader(){
  const R=session[session.active];
  runnerTitle.textContent=`${R.prenom} ${R.nom}`;
  metaRunner.textContent=`${R.classe} ‚Ä¢ ${R.sexe}`;
  lapMetersEl.textContent=session.tourM;
  targetEl.textContent=session.dureeMin;
}
function paintRunnerBadge(){ const R=session[session.active]; runnerBadge.textContent = (R?.prenom || '‚Äî'); }

/* ============ Rendu & verrous ============ */
function renderAll(){ renderLaps(); renderAllowances(); renderShots(); renderSummaryCounters(); }
function disableRaceInputs(disabled){
  qs('#lapPlus').disabled  = disabled;
  qs('#lapMinus').disabled = disabled;
  document.querySelectorAll('#scoreButtons button').forEach(b=> b.disabled = disabled);
}

/* ============ Tours ============ */
qs('#lapPlus').onclick=()=>{ if(timeOver || !raceRunning) return showToast('Action indisponible.');
  const allowed=calcAllowedShots(); const pending=allowed-session.shots.length;
  if(pending>0){ showToast(`D'abord tirer ${pending} fl√®che${pending>1?'s':''}`); return; } session.laps++; renderAll(); };
qs('#lapMinus').onclick=()=>{ if(timeOver || !raceRunning) return showToast('Action indisponible.');
  session.laps=Math.max(0,session.laps-1); renderAll(); };
function renderLaps(){ lapsEl.textContent=session.laps; liveDistanceEl.textContent=Math.round((session.laps+(session.frac||0))*session.tourM); }

/* ============ R√®gles Tours ‚Üí Fl√®ches ============ */
function calcAllowedShots(){ const {tb,fb}=session.rules; const blocs=Math.floor(session.laps/tb); return blocs*fb; }
const allowedEl=qs('#allowed'), shotCountEl=qs('#shotCount'), remainEl=qs('#remain'), remainChip=qs('#remainChip');
function renderAllowances(){
  const allowed=calcAllowedShots(); const remain=Math.max(0,allowed-session.shots.length);
  allowedEl.textContent=allowed; shotCountEl.textContent=session.shots.length; remainEl.textContent=remain;
  if(remain>0) remainChip.classList.add('glow'); else remainChip.classList.remove('glow');
  qs('#lapPlus').disabled = (remain>0) || timeOver;
}

/* ============ Tir + Zone 2 (3 fl√®ches) ============ */
const shotsTable=qs('#shotsTable');
document.querySelectorAll('#scoreButtons [data-score]').forEach(btn=>{
  btn.onclick=()=>{
    if(timeOver || !raceRunning) return showToast('Action indisponible.');
    const allowed=calcAllowedShots();
    if(session.shots.length>=allowed){
      const need = session.rules.tb - (session.laps % session.rules.tb || session.rules.tb);
      showToast(`Pas assez de tours : +${need} tour${need>1?'s':''}`); return;
    }
    const score=+btn.getAttribute('data-score');
    const fb=session.rules.fb;

    addShot(score);
    if(session.adviceEnabled) setAdviceSmart('shot');

    // Consommer Z2 si actif
    if(zone2ShotsRemaining>0){
      zone2ShotsRemaining--;
      updateZoneVisuals();
    }

    // Fin de vol√©e -> √©valuer aide pour la prochaine vol√©e (programmation Z2)
    if(session.shots.length % fb === 0){
      maybeScheduleAssistForNextVolley();
    }
  };
});
function addShot(score){
  session.shots.push({n:session.shots.length+1, score});
  renderShots(); renderAllowances(); renderSummaryCounters();
}
function renderShots(){
  shotsTable.innerHTML='';
  [...session.shots].slice().reverse().forEach(s=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${s.n}</td><td>${s.score}</td><td><button class="b-red btn-lg">Retirer</button></td>`;
    tr.querySelector('button').onclick=()=>{
      if(timeOver || !raceRunning) return showToast('Action indisponible.');
      session.shots=session.shots.filter(x=>x.n!==s.n).map((x,i)=>({n:i+1,score:x.score}));
      renderShots(); renderAllowances(); renderSummaryCounters();
    };
    shotsTable.append(tr);
  });
}
function maybeScheduleAssistForNextVolley(){
  const fb=session.rules.fb; if(!session.assistEnabled || fb<=0) return;
  const lastVolley = session.shots.slice(-fb);
  const zeros = lastVolley.filter(s=>s.score===0).length;
  const sum   = lastVolley.reduce((a,b)=>a+b.score,0);
  const needAssist = (zeros>=session.thrZeros) || (sum<=session.thrSum);
  zone2ShotsRemaining = needAssist ? fb : 0; // 3 fl√®ches en Z2 si besoin
  updateZoneVisuals();
}
function updateZoneVisuals(){
  zoneBadge.textContent = 'Zone 1';
  const z2 = qs('#zone2Banner');
  if(zone2ShotsRemaining>0){ z2.classList.remove('hidden'); z2.removeAttribute('hidden'); }
  else { z2.classList.add('hidden'); z2.setAttribute('hidden',''); }
}

/* ============ Indice & compteurs ============ */
const c0El=qs('#c0'), c6El=qs('#c6'), c7El=qs('#c7'), c8El=qs('#c8'), c9El=qs('#c9'), c10El=qs('#c10'), indiceArcEl=qs('#indiceArc');
function scoreCounts(){ const c={0:0,6:0,7:0,8:0,9:0,10:0}; session.shots.forEach(s=>{ if(c.hasOwnProperty(s.score)) c[s.score]++; }); return c; }
function sumScores(){ return session.shots.reduce((a,b)=> a + ((b&&b.score)||0), 0); }
function computeIndiceArc(){ const T=session.shots.length; if(!T) return 0; const avg=sumScores()/T; return +(avg*10).toFixed(2); }
function renderSummaryCounters(){ const c=scoreCounts();
  c0El.textContent=c[0]; c6El.textContent=c[6]; c7El.textContent=c[7]; c8El.textContent=c[8]; c9El.textContent=c[9]; c10El.textContent=c[10];
  indiceArcEl.textContent=computeIndiceArc(); }

/* ============ Conseils + Encouragements + Humour (6e) ============ */
const adviceBox=qs('#adviceBox'), adviceTxt=qs('#adviceTxt');
const ADVICE_COOLDOWN_EVENTS=3; const adviceHistory=[];
const ADICT={
  breath:"Respire calmement.",
  breath5:"Ferme les yeux, 5 respirations.",
  anchor:"Tiens mieux ton arc.",
  routine:"Refais pareil.",
  tempo:"Prends ton temps.",
  hydrate:"Bois un peu.",
  focus:"Reste concentr√©."
};

// Encouragements adapt√©s au dernier tir
const ENCOURAGE_START = [
  "Respire, c‚Äôest parti üí™",
  "Calme et pr√©cis.",
  "Installe ta routine, tranquillement."
];
const ENCOURAGE_RES_ZERO = [
  "Pas grave, on repart üí™",
  "On se reconcentre et on aligne.",
  "Respire, vise pos√©, √ßa va venir.",
  "Ne l√¢che rien, tu sais faire !"
];
const ENCOURAGE_RES_LOW = [
  "On s‚Äôaccroche, √ßa va le faire.",
  "Reste calme, corrige l‚Äôappui.",
  "Concentre-toi, vise plus longtemps.",
  "Pense routine, on repart."
];
const ENCOURAGE_NEUTRAL = [
  "Propre, garde le focus.",
  "Stable, encha√Æne.",
  "Continue comme √ßa.",
  "On maintient la pr√©cision."
];
const ENCOURAGE_POS = [
  "Top, on continue !",
  "Super, encha√Æne !",
  "C‚Äôest bien parti !",
  "Solide !"
];

function randFrom(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function pickEncouragement(lastScore, hasShots){
  if(!hasShots) return randFrom(ENCOURAGE_START);
  if(lastScore===0) return randFrom(ENCOURAGE_RES_ZERO);
  if(lastScore===6) return randFrom(ENCOURAGE_RES_LOW);
  if(lastScore>=9)  return randFrom(ENCOURAGE_POS);
  if(lastScore>=7)  return randFrom(ENCOURAGE_NEUTRAL);
  return randFrom(ENCOURAGE_NEUTRAL);
}
function lastThreeAreTen(){
  const L = session.shots.length;
  if(L<3) return false;
  return session.shots[L-1].score===10 && session.shots[L-2].score===10 && session.shots[L-3].score===10;
}

function showAdviceBox(){ adviceBox.style.display=''; }
function hideAdviceBox(){ adviceBox.style.display='none'; }
function pushAdviceTypeOnce(type, bag){
  if(!type) return;
  if(adviceHistory.slice(-ADVICE_COOLDOWN_EVENTS).includes(type)) return;
  bag.push(type);
}

function buildAdviceTypes(context){
  const types=[]; const T=session.shots.length; const indice=computeIndiceArc();
  if(context==='shot' && T>0){
    const last=session.shots[T-1].score;
    if(last===0){ if(T===1) pushAdviceTypeOnce('breath5',types); else pushAdviceTypeOnce('breath',types); pushAdviceTypeOnce('anchor',types); }
    else if(last<=6){ pushAdviceTypeOnce('anchor',types); pushAdviceTypeOnce('tempo',types); }
    else if(last<=8){ pushAdviceTypeOnce('focus',types); }
    else { pushAdviceTypeOnce('routine',types); }
  }
  if(indice<40) pushAdviceTypeOnce('breath',types);
  else if(indice<70) pushAdviceTypeOnce('focus',types);
  else pushAdviceTypeOnce('routine',types);

  if(context==='end'){ pushAdviceTypeOnce('hydrate',types); }
  return types;
}

function setAdvice(t){
  if(!session.adviceEnabled){ hideAdviceBox(); return; }
  showAdviceBox();
  const T=session.shots.length;
  const last = T? session.shots[T-1].score : null;
  adviceTxt.textContent = (t&&t.trim()) ? t : pickEncouragement(last, !!T);
}

function setAdviceSmart(context){
  if(!session.adviceEnabled) return;
  const types=buildAdviceTypes(context);
  types.forEach(t=>adviceHistory.push(t));
  while(adviceHistory.length>20) adviceHistory.shift();

  const T=session.shots.length;
  const last = T? session.shots[T-1].score : null;

  // Base : jusqu‚Äô√† 2 conseils (3 √† la fin)
  let base = types.slice(0,(context==='end')?3:2).map(t=>ADICT[t]).join(' ');

  // Ajout encouragement si pas de conseil sp√©cifique ou tir bas (0/6)
  const genericOnly = types.length>0 && types.every(t=> t==='routine' || t==='focus');
  const needResilience = (last===0 || last===6);
  if(!base || genericOnly || needResilience){
    const enc = pickEncouragement(last, !!T);
    base = base ? (base+' '+enc) : enc;
  }

  // Humour 6e : seulement si beaucoup de r√©ussites (indice ‚â• 85) ET 3√ó10 de suite, avec une proba pour √©viter la surabondance
  if(context==='shot' && lastThreeAreTen() && computeIndiceArc()>=85){
    if(Math.random() < 0.35){ // 35% des fois
      base += " üèÜ Tripl√© de 10 ! Bravo Robin des Bois üòâ";
    }
  }

  setAdvice(base);
}

function resetAdviceHistory(){ adviceHistory.length = 0; }

/* ============ Fin de temps : bandeau central ============ */
const modalEnd=qs('#modalEnd'), endActionBtn=qs('#endAction'), distanceOut=qs('#distanceOut');
document.querySelectorAll('[data-frac]').forEach(b=> b.onclick=()=>{ if(!timeOver) return; session.frac=+b.getAttribute('data-frac'); updateDistanceOut(); });
function openModalEnd(){ modalEnd.classList.add('show'); modalEnd.removeAttribute('hidden'); updateDistanceOut();
  endActionBtn.textContent = (phase==='runner1') ? '‚û°Ô∏è Course 2' : 'üìä Voir le bilan';
  if(navigator.vibrate) navigator.vibrate(120);
}
function closeModalEnd(){ modalEnd.classList.remove('show'); modalEnd.setAttribute('hidden',''); }
function updateDistanceOut(){ const meters=Math.round((session.laps+(session.frac||0))*session.tourM); distanceOut.textContent=`Distance : ${meters} m`; }

endActionBtn.onclick = ()=>{
  if(phase === 'runner1'){
    finalizeRunnerPartial(); phase = 'runner2'; closeModalEnd(); prepareNextRunner('p2');
  }else{
    finalizeRunnerPartial(); phase = 'done'; closeModalEnd(); buildSummaryFromResults(); show('summary'); renderSummary(false);
  }
};

function finalizeRunnerPartial(){
  const R=session[session.active]; const meters=Math.round((session.laps+(session.frac||0))*session.tourM);
  const c=scoreCounts(); const indice=computeIndiceArc();
  session.results[session.active]={ prenom:R.prenom, nom:R.nom, classe:R.classe, sexe:R.sexe, distance:meters,
    nb0:c[0], nb6:c[6], nb7:c[7], nb8:c[8], nb9:c[9], nb10:c[10], indice_arc:indice };
}

function prepareNextRunner(which){
  session.active=which;
  resetAdviceHistory();
  raceRunning=false; timeOver=false; running=false; clearInterval(timer); elapsed=0; clockEl.textContent='00:00.0';
  session.laps=0; session.shots=[]; session.frac=0; zone2ShotsRemaining=0;
  disableRaceInputs(false);
  qs('#btnStartChrono').disabled=false; qs('#btnPause').disabled=true; qs('#btnReset').disabled=true;
  qs('#backSetup').disabled=true;
  paintHeader(); paintRunnerBadge(); renderAll(); updateZoneVisuals();
  if(session.adviceEnabled) setAdvice("Respire calmement. Reste concentr√©."); else hideAdviceBox();
}

/* ============ R√©sum√© / QR / CSV / Mode Prof ============ */
let summaryData=[];
let editMode=false;

function buildSummaryFromResults(){ const out=[]; if(session.results.p1) out.push({...session.results.p1}); if(session.results.p2) out.push({...session.results.p2}); summaryData=out; }
function buildQrData(rows){ return rows.map(d=>({nom:d.nom, prenom:d.prenom, classe:d.classe, sexe:d.sexe,
  distance:d.distance, nb0:d.nb0, nb6:d.nb6, nb7:d.nb7, nb8:d.nb8, nb9:d.nb9, nb10:d.nb10, indice_arc:d.indice_arc })); }
function buildQR(payload){ const box=qs('#qr'); box.innerHTML=''; try{ if(window.QRCode){ new QRCode(box,{ text:payload, width:256, height:256, correctLevel:QRCode.CorrectLevel.M }); } }catch(e){ console.warn('QR non g√©n√©r√©',e); } }
function toCSV(data){ const H=['nom','prenom','classe','sexe','distance','nb0','nb6','nb7','nb8','nb9','nb10','indice_arc'];
  const esc=v=>{ const s=(v==null?'':String(v)); return /[;\"\n]/.test(s)? `"${s.replace(/\"/g,'""')}"` : s; };
  return [H.join(';'), ...data.map(d=>H.map(h=>esc(d[h])).join(';'))].join('\n'); }

function renderSummary(asEdit=false){
  editMode = !!asEdit;
  const note = qs('#summaryNote');
  const btnSave = qs('#btnSaveEdits');
  const btnCancel = qs('#btnCancelEdits');
  if(editMode){
    note.textContent = 'Mode prof activ√© : le tableau est modifiable. Pensez √† enregistrer vos corrections avant le QR.';
    btnSave.classList.remove('hidden'); btnSave.removeAttribute('hidden');
    btnCancel.classList.remove('hidden'); btnCancel.removeAttribute('hidden');
  }else{
    note.textContent = 'Le tableau est non-modifiable (Param√®tres simplifi√©s).';
    btnSave.classList.add('hidden'); btnSave.setAttribute('hidden','');
    btnCancel.classList.add('hidden'); btnCancel.setAttribute('hidden','');
  }

  const rows = summaryData.map((d,i)=>{
    if(!editMode){
      return `<tr data-index="${i}">
        <td>${d.nom}</td>
        <td>${d.prenom}</td>
        <td>${d.classe}</td>
        <td>${d.sexe}</td>
        <td>${d.distance}</td>
        <td>${d.nb0}</td>
        <td>${d.nb6}</td>
        <td>${d.nb7}</td>
        <td>${d.nb8}</td>
        <td>${d.nb9}</td>
        <td>${d.nb10}</td>
        <td>${d.indice_arc}</td>
      </tr>`;
    }else{
      return `<tr data-index="${i}">
        <td><input class="edit-input" data-f="nom" value="${d.nom||''}"></td>
        <td><input class="edit-input" data-f="prenom" value="${d.prenom||''}"></td>
        <td><input class="edit-input" data-f="classe" value="${d.classe||''}"></td>
        <td>
          <select class="edit-input" data-f="sexe">
            <option ${d.sexe==='F'?'selected':''}>F</option>
            <option ${d.sexe==='M'?'selected':''}>M</option>
          </select>
        </td>
        <td><input class="edit-input" data-f="distance" type="number" step="1" value="${d.distance||0}"></td>
        <td><input class="edit-input" data-f="nb0" type="number" step="1" value="${d.nb0||0}"></td>
        <td><input class="edit-input" data-f="nb6" type="number" step="1" value="${d.nb6||0}"></td>
        <td><input class="edit-input" data-f="nb7" type="number" step="1" value="${d.nb7||0}"></td>
        <td><input class="edit-input" data-f="nb8" type="number" step="1" value="${d.nb8||0}"></td>
        <td><input class="edit-input" data-f="nb9" type="number" step="1" value="${d.nb9||0}"></td>
        <td><input class="edit-input" data-f="nb10" type="number" step="1" value="${d.nb10||0}"></td>
        <td><input class="edit-input" data-f="indice_arc" type="number" step="0.01" value="${d.indice_arc||0}"></td>
      </tr>`;
    }
  }).join('');

  qs('#resume').innerHTML = `
    <details open>
      <summary>Tableau r√©capitulatif</summary>
      <div style="overflow:auto; margin-top:8px">
        <table>
          <thead><tr>
            <th>Nom</th><th>Pr√©nom</th><th>Classe</th><th>Sexe</th>
            <th>Distance (m)</th><th>Nb 0</th><th>Nb 6</th><th>Nb 7</th><th>Nb 8</th><th>Nb 9</th><th>Nb 10</th>
            <th>Indice (%)</th>
          </tr></thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    </details>`;

  // QR (toujours mis √† jour sur l'√©tat courant)
  const payloadQR = JSON.stringify(buildQrData(summaryData));
  const box=qs('#qr'); box.innerHTML='';
  try{ if(window.QRCode){ new QRCode(box,{ text:payloadQR, width:256, height:256, correctLevel:QRCode.CorrectLevel.M }); } }catch(e){}
}

// Bouton Mode prof (code 57)
qs('#btnProfMode').onclick = ()=>{
  if(editMode){ return; }
  const code = prompt('Entrer le code Mode prof :');
  if(code==='57'){
    renderSummary(true);
    showToast('Mode prof activ√©.');
  }else if(code!=null){
    showToast('Code invalide.');
  }
};

// Sauvegarder les corrections
qs('#btnSaveEdits').onclick = ()=>{
  const tbody = qs('#resume tbody');
  const rows = Array.from(tbody.querySelectorAll('tr'));
  const next = rows.map(tr=>{
    const i = +tr.getAttribute('data-index');
    const base = {...summaryData[i]};
    const inputs = tr.querySelectorAll('.edit-input');
    inputs.forEach(inp=>{
      const f = inp.getAttribute('data-f');
      let v = inp.value;
      if(['distance','nb0','nb6','nb7','nb8','nb9','nb10'].includes(f)){
        v = Math.max(0, Math.floor(+v||0));
      }
      if(f==='indice_arc'){
        v = +(+v||0).toFixed(2);
      }
      base[f] = v;
    });
    // Recalculer indice si compteurs chang√©s (prioritaire par rapport au champ saisi)
    const T = (+base.nb0)+(+base.nb6)+(+base.nb7)+(+base.nb8)+(+base.nb9)+(+base.nb10);
    if(T>0){
      const P = 6*(+base.nb6) + 7*(+base.nb7) + 8*(+base.nb8) + 9*(+base.nb9) + 10*(+base.nb10);
      base.indice_arc = +(((P/T)/10)*100).toFixed(2);
    }else{
      base.indice_arc = +(+base.indice_arc||0).toFixed(2);
    }
    // Normaliser sexe
    base.sexe = (base.sexe||'').toUpperCase()==='M' ? 'M' : 'F';
    return base;
  });
  summaryData = next;
  renderSummary(false);
  showToast('Modifications enregistr√©es.');
};

// Annuler l‚Äô√©dition
qs('#btnCancelEdits').onclick = ()=>{ renderSummary(false); showToast('√âdition annul√©e.'); };

// Export CSV
qs('#exportCsv').onclick=()=>{ const csv=toCSV(summaryData); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`ArcAthlon_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); };

// Retour
qs('#backToCourse').onclick=()=> show('course');

/* ============ Init ============ */
function resetRunnerState(hard=false){
  if(hard){
    running=false; clearInterval(timer); elapsed=0; clockEl.textContent='00:00.0';
    qs('#btnStartChrono').disabled=false; qs('#btnPause').disabled=true; qs('#btnReset').disabled=true;
  }
  session.laps=0; session.shots=[]; session.frac=0; zone2ShotsRemaining=0;
  disableRaceInputs(false); closeModalEnd(); resetAdviceHistory();
  if(session.adviceEnabled) setAdvice("Respire calmement. Reste concentr√©."); else hideAdviceBox();
  updateZoneVisuals(); renderAll();
}
validate();
qs('#aid_thrZeros').textContent = settings.thrZeros;
qs('#aid_thrSum').textContent = settings.thrSum;
try{ console.assert(!!V.cover && !!V.setup && !!V.course && !!V.summary, 'vues ok'); }catch(_){}
</script>
</body>
</html>
