(()=>{const $=(s,r=document)=>r.querySelector(s),$$=(s,r=document)=>Array.from(r.querySelectorAll(s)),SVGNS="http://www.w3.org/2000/svg",ALLOWED=[0,6,7,8,9,10];const state={board:[],centers:[],teams:[{name:"√âquipe A",color:"#5ac8fa",p1:"A1",p2:"A2",pos:0,cumul:0,skip:0},{name:"√âquipe B",color:"#ff7b7b",p1:"B1",p2:"B2",pos:0,cumul:0,skip:0}],round:1,history:[]};
function setView(id){$$(".screen").forEach(n=>n.classList.remove("active"));$$(".btn.tab").forEach(b=>b.classList.remove("active"));$(id).classList.add("active");if(id==="#view-input")$("#tab-input").classList.add("active");if(id==="#view-board")$("#tab-board").classList.add("active")}$("#tab-input").addEventListener("click",()=>setView("#view-input"));$("#tab-board").addEventListener("click",()=>setView("#view-board"));
function spiralPosOutsideIn(i,N){const cx=700,cy=700,step=.5,Rmax=520,b=10,th=i*step,r=Math.max(40,Rmax-b*th);return{x:cx+r*Math.cos(th),y:cy+r*Math.sin(th)}}function buildCenters(){const N=state.board.length-1;state.centers=state.board.map((_,i)=>spiralPosOutsideIn(i,N))}
function renderBoard(){const svg=$("#board");svg.innerHTML="";const defs=document.createElementNS(SVGNS,"defs"),grad=document.createElementNS(SVGNS,"radialGradient");grad.setAttribute("id","finishGrad");const s1=document.createElementNS(SVGNS,"stop");s1.setAttribute("offset","0%");s1.setAttribute("stop-color","#ffb703");const s2=document.createElementNS(SVGNS,"stop");s2.setAttribute("offset","100%");s2.setAttribute("stop-color","#7b2cbf");grad.appendChild(s1);grad.appendChild(s2);defs.appendChild(grad);const marker=document.createElementNS(SVGNS,"marker");marker.setAttribute("id","arrow");marker.setAttribute("viewBox","0 0 10 10");marker.setAttribute("refX","5");marker.setAttribute("refY","5");marker.setAttribute("markerWidth","9");marker.setAttribute("markerHeight","9");marker.setAttribute("orient","auto-start-reverse");const p=document.createElementNS(SVGNS,"path");p.setAttribute("d","M 0 0 L 10 5 L 0 10 z");p.setAttribute("fill","#4cc9f0");marker.appendChild(p);defs.appendChild(marker);svg.appendChild(defs);buildCenters();const pathShadow=document.createElementNS(SVGNS,"polyline");pathShadow.setAttribute("id","path-shadow");pathShadow.setAttribute("points",state.centers.map(c=>`${c.x},${c.y}`).join(" "));svg.appendChild(pathShadow);const path=document.createElementNS(SVGNS,"polyline");path.setAttribute("id","path");path.setAttribute("points",state.centers.map(c=>`${c.x},${c.y}`).join(" "));path.setAttribute("marker-end","url(#arrow)");svg.appendChild(path);state.board.forEach((sq,i)=>{const g=document.createElementNS(SVGNS,"g");g.setAttribute("class",`square${i%2===1?" dark":""}${sq.type?" "+sq.type:""}${i===state.board.length-1?" finish":""}`);const {x,y}=state.centers[i],w=68,h=54;g.setAttribute("transform",`translate(${x-w/2},${y-h/2})`);const r=document.createElementNS(SVGNS,"rect");r.setAttribute("width",w);r.setAttribute("height",h);r.setAttribute("rx","14");r.setAttribute("ry","14");const t=document.createElementNS(SVGNS,"text");t.setAttribute("x",w/2);t.setAttribute("y",h/2+6);t.setAttribute("text-anchor","middle");t.textContent=sq.hidden?"?":(sq.label||i);const title=document.createElementNS(SVGNS,"title");title.textContent=(sq.hidden?"Myst√®re":(sq.label||("Case "+i)))+` (#${i})`;g.appendChild(r);g.appendChild(t);g.appendChild(title);svg.appendChild(g)});placeTokens(true)}
function placeTokens(initial=false){$$(".token",$("#board")).forEach(n=>n.remove());state.teams.forEach(tm=>{const {x,y}=state.centers[tm.pos],g=document.createElementNS(SVGNS,"g");g.setAttribute("class","token duo");g.setAttribute("transform",`translate(${x-10},${y-36})`);const c1=document.createElementNS(SVGNS,"circle");c1.setAttribute("class","c1");c1.setAttribute("cx","10");c1.setAttribute("cy","10");c1.setAttribute("fill",tm.color);const r1=document.createElementNS(SVGNS,"circle");r1.setAttribute("class","ring c1");r1.setAttribute("cx","10");r1.setAttribute("cy","10");r1.setAttribute("r","14");const c2=document.createElementNS(SVGNS,"circle");c2.setAttribute("class","c2");c2.setAttribute("cx","10");c2.setAttribute("cy","10");c2.setAttribute("fill",tm.color);const r2=document.createElementNS(SVGNS,"circle");r2.setAttribute("class","ring c2");r2.setAttribute("cx","10");r2.setAttribute("cy","10");r2.setAttribute("r","14");const title=document.createElementNS(SVGNS,"title");title.textContent=`${tm.name} (#${tm.pos})`;g.appendChild(c1);g.appendChild(r1);g.appendChild(c2);g.appendChild(r2);g.appendChild(title);$("#board").appendChild(g)});if(initial)return}
function revealMystery(sq){const ch=[{type:"bonus",value:2,label:"+2 bonus"},{type:"malus",value:2,label:"-2 malus"},{type:"skip",value:1,label:"Saut 1 tour"},{type:"teleport",value:6,label:"T√©l√©port ‚Üí 6"},{type:"steal",value:1,label:"Vole 1 fl√®che"}];Object.assign(sq,ch[Math.floor(Math.random()*ch.length)],{hidden:false})}
function applyEffect(teamIndex,sq,lastAdvance){const team=state.teams[teamIndex];let msg="";if(sq.hidden)revealMystery(sq);switch(sq.type){case"bonus":team.pos=Math.min(team.pos+(sq.value||0),state.board.length-1);msg=`Bonus +${sq.value}`;break;case"malus":team.pos=Math.max(team.pos-(sq.value||0),0);msg=`Malus -${sq.value}`;break;case"skip":team.skip=(team.skip||0)+1;msg="‚è≠Ô∏è Sautera le prochain tour";break;case"teleport":{const dest=Number(sq.value||0);team.pos=dest<=state.board.length-1?dest:Math.min(state.board.length-1,team.pos+dest);msg=`üåÄ T√©l√©port ‚Üí #${team.pos}`;}break;case"goal":msg=`üéØ Objectif atteint : ${sq.label}`;break;case"replay":msg=`üîÅ Rejoue imm√©diatement (+${lastAdvance})`;break;case"steal":msg="üü° Vole 1 fl√®che (logiciel: info affich√©e)";break;default:msg=""}return msg}
function makeSelect(){const sel=document.createElement("select");["",...ALLOWED].forEach(v=>{const o=document.createElement("option");o.value=String(v);o.textContent=v===""?"‚Äî":String(v);sel.appendChild(o)});return sel}
function buildInputTable(){const tbody=$("#tbody-scores");tbody.innerHTML="";[{team:"A",shooter:"A1"},{team:"A",shooter:"A2"},{team:"B",shooter:"B1"},{team:"B",shooter:"B2"}].forEach(r=>{const tr=document.createElement("tr");tr.innerHTML=`<td>√âquipe ${r.team}</td><td>${r.shooter}</td>`;for(let i=1;i<=3;i++){const td=document.createElement("td");const sel=makeSelect();sel.id=`${r.shooter}-a${i}`;td.appendChild(sel);tr.appendChild(td)}const best=document.createElement("td");best.id=`${r.shooter}-best`;best.textContent="0";tr.appendChild(best);tbody.appendChild(tr)})}
function bestOfShooter(prefix){const v=[];for(let i=1;i<=3;i++){v.push(Number(($("#"+prefix+"-a"+i).value)||0))}return Math.max(0,...v)}
function computeTotals(){const a1=bestOfShooter("A1"),a2=bestOfShooter("A2"),b1=bestOfShooter("B1"),b2=bestOfShooter("B2");$("#A1-best").textContent=String(a1);$("#A2-best").textContent=String(a2);$("#B1-best").textContent=String(b1);$("#B2-best").textContent=String(b2);const totalA=a1+a2,totalB=b1+b2;$("#totalA").textContent=String(totalA);$("#totalB").textContent=String(totalB);return{A:{a1,a2,total:totalA},B:{b1,b2,total:totalB}}}
function highlightPath(from,steps){const d=70;for(let i=1;i<=steps;i++){const idx=Math.min(from+i,state.board.length-1),g=$$(".square")[idx];setTimeout(()=>g&&g.classList.add("highlight"),i*d);setTimeout(()=>g&&g.classList.remove("highlight"),i*d+600)}}function moveTeamAnimated(idx,steps){return new Promise(res=>{if(steps===0)return res();const t=state.teams[idx];let rem=Math.abs(steps),dir=Math.sign(steps);const tick=()=>{t.pos=Math.max(0,Math.min(t.pos+dir,state.board.length-1));placeTokens();rem--;if(rem>0)setTimeout(tick,180);else res()};setTimeout(tick,120)})}
async function runRound(tot){setView("#view-board");const fromA=state.teams[0].pos,fromB=state.teams[1].pos;$("#hud").hidden=false;$("#hud-text").innerHTML=`<b>${state.teams[0].name}</b>: ${tot.A.a1}+${tot.A.a2}=<b>${tot.A.total}</b> | <b>${state.teams[1].name}</b>: ${tot.B.b1}+${tot.B.b2}=<b>${tot.B.total}</b>`;highlightPath(fromA,tot.A.total);highlightPath(fromB,tot.B.total);await moveTeamAnimated(0,tot.A.total);const sqA=state.board[state.teams[0].pos],eA=applyEffect(0,sqA,tot.A.total);if(eA){$("#modal-content").innerHTML=`‚Ä¢ ${state.teams[0].name}: ${eA}`;$("#modal").showModal()}await moveTeamAnimated(1,tot.B.total);const sqB=state.board[state.teams[1].pos],eB=applyEffect(1,sqB,tot.B.total);if(eB){$("#modal-content").innerHTML+=`<br>‚Ä¢ ${state.teams[1].name}: ${eB}`;if(!$("#modal").open)$("#modal").showModal()}}
$("#btn-calc").addEventListener("click",computeTotals);$("#btn-validate").addEventListener("click",async()=>{const tot=computeTotals(),from=[state.teams[0].pos,state.teams[1].pos];await runRound(tot);const to=[state.teams[0].pos,state.teams[1].pos];state.history.push({from,to,snapshot:JSON.stringify(state)});state.round++});$("#btn-undo").addEventListener("click",async()=>{if(!state.history.length){$("#modal-content").textContent="Rien √† annuler.";$("#modal").showModal();return}const last=state.history.pop(),cur=[state.teams[0].pos,state.teams[1].pos];await moveTeamAnimated(0,last.from[0]-cur[0]);await moveTeamAnimated(1,last.from[1]-cur[1])});$("#modal-close").addEventListener("click",()=>$("#modal").close());
function defaultBoard(){const N=63,sp={4:{type:"goal",label:"üéØ Objectif: Avance +4"},5:{type:"bonus",value:2,label:"+2 bonus"},8:{type:"goal",label:"üéØ Objectif: ‚Üí +10"},9:{type:"malus",value:2,label:"-2 malus"},12:{type:"goal",label:"üéØ Objectif: Rejouer"},13:{type:"skip",value:1,label:"Saut 1 tour"},16:{type:"goal",label:"üéØ Objectif: Vole 1 fl√®che"},19:{type:"teleport",value:6,label:"T√©l√©port ‚Üí 6"},23:{type:"bonus",value:3,label:"+3 bonus"},27:{type:"mystery",value:0,label:"Myst√®re ?",hidden:true},31:{type:"bonus",value:2,label:"+2 bonus"},34:{type:"replay",value:0,label:"Rejouer"},36:{type:"malus",value:3,label:"-3 malus"},41:{type:"mystery",value:0,label:"Myst√®re ?",hidden:true},45:{type:"skip",value:1,label:"Saut 1 tour"},48:{type:"steal",value:1,label:"Vole 1 fl√®che"},50:{type:"bonus",value:2,label:"+2 bonus"},54:{type:"malus",value:4,label:"-4 malus"},58:{type:"teleport",value:32,label:"T√©l√©port ‚Üí 32"},60:{type:"mystery",value:0,label:"Myst√®re ?",hidden:true}};const arr=[];for(let i=0;i<=N;i++){if(i===0)arr.push({index:i,label:"D√©part",type:"",value:0});else if(i===N)arr.push({index:i,label:"Arriv√©e üéØ",type:"",value:0});else if(sp[i])arr.push({index:i,...sp[i]});else arr.push({index:i,label:String(i),type:"",value:0})}return arr}
function init(){buildInputTable();state.board=defaultBoard();renderBoard()}init()})();